define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/core/NotificationUtils","alfresco/core/ObjectTypeUtils","dojo/request/xhr","dojo/json","dojo/_base/lang","alfresco/buttons/AlfButton","service/constants/Default"],function(e,s,y,A,l,L,i,f,m,x){return e([s,y,A],{i18nRequirements:[{i18nFile:"./i18n/SiteService.properties"}],constructor:function w(O){f.mixin(this,O);this.alfSubscribe("ALF_GET_SITES",f.hitch(this,this.getSites));this.alfSubscribe("ALF_GET_SITES_ADMIN",f.hitch(this,this.getAdminSites));this.alfSubscribe("ALF_GET_SITE_MEMBERSHIPS",f.hitch(this,this.getSiteMemberships));this.alfSubscribe("ALF_GET_SITE_DETAILS",f.hitch(this,this.getSiteDetails));this.alfSubscribe("ALF_UPDATE_SITE_DETAILS",f.hitch(this,this.updateSite));this.alfSubscribe("ALF_BECOME_SITE_MANAGER",f.hitch(this,this.becomeSiteManager));this.alfSubscribe("ALF_JOIN_SITE",f.hitch(this,this.joinSite));this.alfSubscribe("ALF_REQUEST_SITE_MEMBERSHIP",f.hitch(this,this.requestSiteMembership));this.alfSubscribe("ALF_LEAVE_SITE",f.hitch(this,this.leaveSiteRequest));this.alfSubscribe("ALF_LEAVE_SITE_CONFIRMATION",f.hitch(this,this.leaveSite));this.alfSubscribe("ALF_CREATE_SITE",f.hitch(this,this.createSite));this.alfSubscribe("ALF_EDIT_SITE",f.hitch(this,this.editSite));this.alfSubscribe("ALF_DELETE_SITE",f.hitch(this,this.onActionDeleteSite));this.alfSubscribe("ALF_ADD_FAVOURITE_SITE",f.hitch(this,this.addSiteAsFavourite));this.alfSubscribe("ALF_REMOVE_FAVOURITE_SITE",f.hitch(this,this.removeSiteFromFavourites));this.alfSubscribe("ALF_GET_RECENT_SITES",f.hitch(this,this.getRecentSites));this.alfSubscribe("ALF_GET_FAVOURITE_SITES",f.hitch(this,this.getFavouriteSites));var P=this;require([x.URL_RESCONTEXT+"modules/edit-site.js"],function(){P.alfLog("log","Edit Site JavaScript resource loaded")})},getSites:function M(P){var O=P.alfResponseTopic||P.responseTopic;this.serviceXhr({url:x.PROXY_URI+"api/sites",method:"GET",alfTopic:O})},getAdminSites:function v(P){var O=(P.page-1)*P.pageSize;this.serviceXhr({url:x.PROXY_URI+"api/admin-sites?skipCount="+O+"&maxItems="+P.pageSize,method:"GET",alfTopic:P.responseTopic})},getSitesSuccess:function g(Q,P){if(Q!=null&&l.isArray(Q)){var R=(P.responseTopic!=null)?P.responseTopic:"ALF_SITES_LOADED";var O={items:Q};this.alfPublish(R,O)}else{this.alfLog("error","The request to retrieve available sites returned a response that could not be interpreted",Q,P,this)}},getSiteDetails:function N(P){if(P&&P.site&&P.responseTopic){var O=x.PROXY_URI+"api/sites/"+P.site;this.serviceXhr({url:O,method:"GET",site:P.site,responseTopic:P.responseTopic,successCallback:this.publishSiteDetails,callbackScope:this})}else{this.alfLog("error","A request to get the details of a site was made, but either the 'site' or 'responseTopic' attributes was not provided",P)}},publishSiteDetails:function F(P,O){if(O&&O.responseTopic){this.alfLog("log","Publishing site details",O);this.alfPublish(O.responseTopic,P)}else{this.alfLog("error","It was not possible to publish requested site details because the 'responseTopic' attribute was not set on the original request",P,O)}},updateSite:function B(Q){var O=f.getObject("shortName",false,Q);if(O!=null){var P=x.PROXY_URI+"api/sites/"+O;this.serviceXhr({url:P,method:"PUT",data:Q,alfTopic:Q.responseTopic})}else{this.alfLog("warn","A request was made to update a site but no 'shortName' attribute was provided",Q,this)}},onActionDeleteSite:function o(R){var P=R.document;var O=f.getObject("shortName",false,P);if(O!=null){var Q=this.generateUuid();this._actionDeleteHandle=this.alfSubscribe(Q,f.hitch(this,"onActionDeleteSiteConfirmation"),false);this.alfPublish("ALF_CREATE_DIALOG_REQUEST",{dialogTitle:this.message("message.delete-site-confirm-title"),textContent:this.message("message.delete-site-prompt",{"0":O}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.delete-site.confirm-label"),publishTopic:this.pubSubScope+Q,publishPayload:R}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.delete-site.cancel-label"),publishTopic:"close"}}]})}else{this.alfLog("warn","A request was made to delete a site but no 'shortName' attribute was provided",P,this)}},onActionDeleteSiteConfirmation:function t(T){this.alfUnsubscribeSaveHandles([this._actionDeleteHandle]);var R=this.generateUuid();var S=this.alfSubscribe(R+"_SUCCESS",f.hitch(this,"onActionDeleteSiteSuccess"),false);var P=T.document;var O=f.getObject("shortName",false,P);if(O!=null){var Q=x.PROXY_URI+"api/sites/"+O;this.serviceXhr({alfTopic:R,subscriptionHandle:S,url:Q,method:"DELETE"})}else{this.alfLog("warn","A request was made to delete a site but no 'shortName' attribute was provided",P,this)}},onActionDeleteSiteSuccess:function b(P){var O=f.getObject("requestConfig.subscriptionHandle",false,P);if(O!=null){this.alfUnsubscribe(O)}this.reloadData()},addSiteAsFavourite:function n(Q){if(Q.site&&Q.user){var P=x.PROXY_URI+"api/people/"+encodeURIComponent(Q.user)+"/preferences",O={org:{alfresco:{share:{sites:{favourites:{}}}}}};O.org.alfresco.share.sites.favourites[Q.site]=true;this.serviceXhr({url:P,site:Q.site,user:Q.user,data:O,method:"POST",successCallback:this.favouriteSiteAdded,callbackScope:this})}else{this.alfLog("error","A request to make a site a favourite but either the site or user was not specified",Q)}},favouriteSiteAdded:function r(P,O){this.alfLog("log","Favourite Site Added Successfully",P,O);this.alfPublish("ALF_FAVOURITE_SITE_ADDED",{site:O.site,user:O.user})},removeSiteFromFavourites:function a(P){if(P.site&&P.user){var O=x.PROXY_URI+"api/people/"+encodeURIComponent(P.user)+"/preferences?pf=org.alfresco.share.sites.favourites."+P.site;this.serviceXhr({url:O,site:P.site,user:P.user,method:"DELETE",successCallback:this.favouriteSiteRemoved,callbackScope:this})}else{this.alfLog("error","A request to remove a site from the favourites list but either the site or user was not specified",P)}},favouriteSiteRemoved:function I(P,O){this.alfLog("log","Favourite Site Removed Successfully",P,O);this.alfPublish("ALF_FAVOURITE_SITE_REMOVED",{site:O.site,user:O.user})},getSiteMemberships:function j(P){if(P&&P.site&&P.responseTopic){var O=x.PROXY_URI+"api/sites/"+P.site+"/memberships";this.serviceXhr({url:O,method:"GET",alfTopic:P.responseTopic})}else{this.alfLog("error","A request to get the details of a site was made, but either the 'site' or 'responseTopic' attributes was not provided",P)}},becomeSiteManager:function c(P){if(P.site){this.alfLog("log","A request has been made for a user to become the manager of a site: ",P);var O=x.PROXY_URI+"api/sites/"+encodeURIComponent(P.site)+"/memberships";var Q={role:(P.role)?P.role:"SiteManager",person:{userName:(P.user)?P.user:x.USERNAME}};this.serviceXhr({url:O,data:Q,method:"POST",successCallback:this.reloadData,callbackScope:this})}else{this.alfLog("error","A request was made for a user to become the manager of a site, but no site was specified",P)}},requestSiteMembership:function D(P){if(P.site&&P.user){this.alfLog("log","A request has been made for a user to join a site: ",P);var O=x.PROXY_URI+"api/sites/"+encodeURIComponent(P.site)+"/invitations";var Q={invitationType:"MODERATED",inviteeRoleName:(P.role)?P.role:"SiteConsumer",inviteeUserName:P.user,inviteeComments:(P.comments)?P.comments:""};this.serviceXhr({url:O,method:"POST",site:P.site,user:P.user,data:Q,successCallback:this.siteMembershipRequestComplete,callbackScope:this})}else{if(!P.site){this.alfLog("error","A request was made to join a site but no site was specified",P)}if(!P.user){this.alfLog("error","A request was made to join a site but no user was specified",P)}}},siteMembershipRequestComplete:function J(P,O){this.alfLog("log","User has successfully requested to join a moderated site",P,O);this.displayPrompt({title:"",textContent:this.message("message.request-join-success",{"0":O.user,"1":O.site}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("label.ok"),publishTopic:"ALF_NAVIGATE_TO_PAGE",publishPayload:{url:"user/"+O.user+"/dashboard",type:"SHARE_PAGE_RELATIVE",target:"CURRENT"}}}]})},joinSite:function G(P){if(P.site&&P.user){this.alfLog("log","A request has been made for a user to join a site: ",P);var O=x.PROXY_URI+"api/sites/"+encodeURIComponent(P.site)+"/memberships";var Q={role:(P.role)?P.role:"SiteConsumer",person:{userName:P.user}};this.serviceXhr({url:O,method:"PUT",site:P.site,user:P.user,data:Q,successCallback:this.siteJoined,callbackScope:this})}else{if(!P.site){this.alfLog("error","A request was made to join a site but no site was specified",P)}if(!P.user){this.alfLog("error","A request was made to join a site but no user was specified",P)}}},siteJoined:function u(P,O){this.alfLog("log","User has successfully joined a site",P,O);this.alfPublish("ALF_SITE_JOINED",{site:O.site,user:O.user});this.reloadPage()},createSite:function C(O){this.alfLog("log","A request has been made to create a site: ",O);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getCreateSiteInstance==="function"){Alfresco.module.getCreateSiteInstance().show()}else{this.alfLog("error","Could not find the 'Alfresco.module.getCreateSiteInstance' function - has 'create-site.js' been included in the page?")}},editSite:function C(O){this.alfLog("log","A request has been made to edit a site: ",O);if(Alfresco&&Alfresco.module&&typeof Alfresco.module.getEditSiteInstance==="function"){Alfresco.module.getEditSiteInstance().show({shortName:O.site})}else{this.alfLog("error","Could not find the 'Alfresco.module.getEditSiteInstance' function - has 'edit-site.js' been included in the page?")}},leaveSiteRequest:function d(O){this.displayPrompt({title:this.message("message.leave",{"0":O.siteTitle}),textContent:this.message("message.leave-site-prompt",{"0":O.siteTitle}),widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.confirm-label"),publishTopic:"ALF_LEAVE_SITE_CONFIRMATION",publishPayload:O}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("button.leave-site.cancel-label"),publishTopic:"ALF_LEAVE_SITE_CANCELLATION",publishPayload:O}}]})},leaveSite:function q(P){if(P.site&&P.user){this.alfLog("log","A request has been made for a user to leave a site: ",P);var O=x.PROXY_URI+"api/sites/"+encodeURIComponent(P.site)+"/memberships/"+encodeURIComponent(P.user);this.serviceXhr({url:O,method:"DELETE",site:P.site,siteTitle:P.siteTitle,user:P.user,userFullName:P.userFullName,successCallback:this.siteLeft,failureCallback:this.siteLeftFailure,callbackScope:this})}else{if(!P.site){this.alfLog("error","A request was made to leave a site but no site was specified",P)}if(!P.user){this.alfLog("error","A request was made to leave a site but no user was specified",P)}}},siteLeft:function z(P,O){this.alfLog("log","User has successfully left a site",P,O);this.displayMessage(this.message("message.leaving",{"0":O.userFullName,"1":O.siteTitle}));this.alfPublish("ALF_SITE_LEFT",{site:O.site,user:O.user});this.leaveSiteSuccess(P,O)},siteLeftFailure:function h(P,O){this.alfLog("log","User has failed to leave a site",P,O);this.displayMessage(this.message("message.leave-failure",{"0":O.userFullName,"1":O.siteTitle}))},reloadPage:function p(P,O){this.alfPublish("ALF_RELOAD_PAGE",{})},reloadData:function k(P,O){this.alfPublish("ALF_DOCLIST_RELOAD_DATA",{})},leaveSiteSuccess:function K(P,O){this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:"user/"+O.user+"/dashboard",type:"SHARE_PAGE_RELATIVE",target:"CURRENT"})},getRecentSites:function E(R){var Q=x.PROXY_URI+"api/people/"+x.USERNAME+"/sites/recent";if(this.currentSite){Q=Q+"/site/"+this.currentSite}var O=(R.alfResponseTopic!=null)?R.alfResponseTopic:"ALF_GET_RECENT_SITES";var P={alfTopic:O,url:Q,method:"GET",callbackScope:this};this.serviceXhr(P)},getFavouriteSites:function H(R){var Q=x.PROXY_URI+"api/people/"+x.USERNAME+"/sites/favourites";if(this.currentSite){Q=Q+"/site/"+this.currentSite}var O=(R.alfResponseTopic!=null)?R.alfResponseTopic:"ALF_GET_FAVOURITE_SITES";var P={alfTopic:O,url:Q,method:"GET",callbackScope:this};this.serviceXhr(P)}})});