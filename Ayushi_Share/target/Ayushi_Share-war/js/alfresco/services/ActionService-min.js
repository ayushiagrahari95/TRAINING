define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","service/constants/Default","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/services/_NavigationServiceTopicMixin","alfresco/core/UrlUtils","alfresco/core/ArrayUtils","alfresco/core/JsNode","alfresco/core/NotificationUtils","dojo/_base/lang","dojo/_base/array","alfresco/dialogs/AlfDialog","alfresco/pickers/Picker","alfresco/core/NodeUtils"],function(c,s,W,A,ad,N,u,x,l,G,f,g,Q,K,a){return c([s,W,ad,N,u,G],{i18nRequirements:[{i18nFile:"./i18n/ActionService.properties"}],siteId:null,containerId:null,rootNode:null,copyMoveTarget:null,copyAPI:"slingshot/doclib/action/copy-to/node/",moveAPI:"slingshot/doclib/action/move-to/node/",constructor:function O(af){f.mixin(this,af);this.currentlySelectedDocuments={};this.alfSubscribe(this.documentsLoadedTopic,f.hitch(this,this.onDocumentsLoaded));this.alfSubscribe(this.metadataChangeTopic,f.hitch(this,this.handleCurrentNodeChange));this.alfSubscribe(this.documentSelectedTopic,f.hitch(this,this.onDocumentSelected));this.alfSubscribe(this.documentDeselectedTopic,f.hitch(this,this.onDocumentDeselected));this.alfSubscribe(this.singleDocumentActionTopic,f.hitch(this,this.handleSingleDocAction));this.alfSubscribe(this.syncLocationTopic,f.hitch(this,this.onSyncLocation));this.alfSubscribe(this.unsyncLocationTopic,f.hitch(this,this.onUnsyncLocation));this.alfSubscribe("ALF_MULTIPLE_DOCUMENT_ACTION_REQUEST",f.hitch(this,this.handleMultiDocLegacyAction));this.alfSubscribe("ALF_CREATE_CONTENT",f.hitch(this,this.processActionObject));this.alfSubscribe("ALF_MOVE_DOCUMENTS",f.hitch(this,this.onMoveDocuments));this.alfSubscribe("ALF_ON_ACTION_DETAILS_SUCCESS",f.hitch(this,this.onActionDetailsSuccess));this.alfSubscribe("ALF_ON_ACTION_EDIT_INLINE_SUCCESS",f.hitch(this,this.onActionEditInlineSucess));this.alfSubscribe("ALF_DOC_CANCEL_EDIT_SUCCESS",f.hitch(this,this.onActionCancelEditingSuccess))},onFileAction:function ac(ag,af){var ah=af[1];if(ah){if(!ah.multiple){this.requestRefresh()}}},requestRefresh:function(){this.alfPublish(this.reloadDataTopic,{})},onDocumentsLoaded:function r(af){this.alfLog("log","New Documents Loaded",af);this.currentlySelectedDocuments={};this.onSelectedFilesChanged()},_currentNode:null,handleCurrentNodeChange:function y(af){if(af&&af.node){this.alfLog("log","Updating current nodeRef to: ",af.node);this._currentNode=af.node}else{this.alfLog("error","A request was made to update the current NodeRef, but no 'node' property was provided in the payload: ",af)}},handleSingleDocAction:function Y(af){this.alfLog("log","Single document action request:",af);if(af&&af.document!=null&&af.action!=null){if(typeof af.action==="string"){if(typeof this[af.action]==="function"){this[af.action](af.document)}else{this.alfLog("warn","No handler implemented to handle this function",this)}}else{if(typeof af.action==="object"){this.processActionObject(af.action,af.document)}}}},handleMultiDocLegacyAction:function L(ah){this.alfLog("log","Multiple document action request:",ah);if(typeof this[ah.action]==="function"){var ag=[];for(var af in this.currentlySelectedDocuments){ag.push(this.currentlySelectedDocuments[af])}this[ah.action].call(this,ah,ag)}},currentlySelectedDocuments:null,selectionTimeout:null,onDocumentSelected:function S(af){if(af&&af.value&&af.value.nodeRef!=null){this.currentlySelectedDocuments[af.value.nodeRef]=af.value;if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,this.deferredSelectionHandler),50)}},deferredSelectionHandler:function I(){this.onSelectedFilesChanged();this.selectionTimeout=null},onDocumentDeselected:function p(af){if(af&&af.value&&af.value.nodeRef!=null){delete this.currentlySelectedDocuments[af.value.nodeRef];if(this.selectionTimeout!=null){clearTimeout(this.selectionTimeout)}this.selectionTimeout=setTimeout(f.hitch(this,this.deferredSelectionHandler),50)}},getSelectedDocumentArray:function P(){var af=[];for(var ag in this.currentlySelectedDocuments){af.push(this.currentlySelectedDocuments[ag])}return af},onSelectedFilesChanged:function i(){var af=this.getSelectedDocumentArray(),ai=[],aj,at,ar={},ag,ao,ak=[],ap=[],am,aq,al,an;var ah=function ah(au){return(au.node.isContainer?"folder":"document")};for(am=0,aq=af.length;am<aq;am++){aj=af[am];ag=aj.node.permissions.user;for(ao in ag){if(ag.hasOwnProperty(ao)){ar[ao]=(ar[ao]===undefined?ag[ao]:ar[ao]&&ag[ao])}}at=ah(aj);if(!(at in ai)){ai[at]=true;ai.push(at)}if(am===0){ak=f.clone(aj.node.aspects)}else{for(al=0,an=ak.length;al<an;al++){if(!x.arrayContains(aj.node.aspects,ak[al])){x.arrayRemove(ak,ak[al])}}}for(al=0,an=aj.node.aspects.length;al<an;al++){if(!x.arrayContains(ap,aj.node.aspects[al])){ap.push(aj.node.aspects[al])}}}this.alfPublish(this.selectedDocumentsChangeTopic,{selectedFiles:af,userAccess:ar,commonAspects:ak,allAspects:ap})},processActionObject:function ab(ag,af){if(ag&&ag.type){if(ag.type=="pagelink"){if(ag.params.page){this.createPageLinkContent(ag,af)}else{this.alfLog("error","A request was made to perform an action. The 'pagelink' type was requested, but no 'page' attribute was provided: ",ag)}}else{if(ag.type=="link"){if(ag.params.href){this.createLinkContent(ag,af)}else{this.alfLog("error","A request was made to perform an action. The 'link' type was requested, but no 'href' attribute was provided: ",ag)}}else{if(ag.type=="javascript"){if(ag.params["function"]){this.createJavaScriptContent(ag,af)}else{this.alfLog("error","A request was made to perform an action. The 'javascript' type was requested, but no 'function' attribute was provided: ",ag)}}else{if(ag.type=="template"){if(ag.params.nodeRef){this.createTemplateContent(ag,af)}else{this.alfLog("error","A request was made to perform an action. The 'template' type was requested, but no 'nodeRef' attribute was provided: ",ag)}}else{this.alfLog("error","A request was made to perform an action, but an unknown 'type' was provided: ",ag)}}}}}else{this.alfLog("error","A request was made to perform an action, but no 'type' was provided in the payload: ",ag)}},createPageLinkContent:function m(aj,af){var ah=aj.params.page;if(af!=null){ah=f.replace(ah,af)}else{if(this._currentNode!=null){ah=f.replace(ah,{nodeRef:this._currentNode.parent.nodeRef})}}var ai={type:this.sharePageRelativePath,url:ah,target:this.currentTarget},ag=f.getObject("location.site.name",false,af);if(ag){ai.site=ag}this.alfPublish(this.navigateToPageTopic,ai)},createLinkContent:function D(aj,af){var ag=f.replace(aj.params.href,this.getActionUrls(af,this.siteId,this.repositoryUrl,this.replicationUrlMapping));var ai=ag.indexOf('" target="_blank');var ah="CURRENT";if(ai!=-1){ag=ag.substring(0,ai);ah="NEW"}this.alfPublish(this.navigateToPageTopic,{type:this.fullPath,url:ag,target:ah})},createJavaScriptContent:function E(ai,af){if(af==null){var ag=f.clone(this._currentNode.parent);af={nodeRef:ag.nodeRef,node:ag,jsNode:new l(ag)}}var ah=this[ai.params["function"]];if(typeof ah==="function"){ah.call(this,ai,[af])}else{this.callLegacyActionHandler(ai.params["function"],af)}},callLegacyActionHandler:function v(){this.alfLog("warn","Legacy toolbar now removed")},onActionDetails:function R(ag,af){af=(f.isArray(af))?af[0]:af;if(af==null||af.nodeRef==null){this.alfLog("warn","A request was made to edit the properties of a document but no document or 'nodeRef' attribute was provided",af,this)}else{this.alfPublish("ALF_RETRIEVE_SINGLE_DOCUMENT_REQUEST",{alfResponseTopic:"ALF_ON_ACTION_DETAILS",nodeRef:af.nodeRef})}},onActionDetailsSuccess:function ae(af){this.alfLog("Error","This method hasn't been implemented yet.")},onActionUploadNewVersion:function w(ag,af){this.alfPublish("ALF_SHOW_UPLOADER",ag)},onActionCancelEditing:function B(ag,af){ag.documents=af;this.alfPublish("ALF_DOC_CANCEL_EDITING",ag)},onActionCancelEditingSuccess:function n(af){this.alfPublish(this.reloadDataTopic,{})},onActionEditInline:function C(ag,af){if(af==null||af.nodeRef==null){this.alfLog("warn","A request was made to edit the properties of a document but no document or 'nodeRef' attribute was provided",af,this)}else{this.alfPublish("ALF_RETRIEVE_SINGLE_DOCUMENT_REQUEST",{alfResponseTopic:"ALF_ON_ACTION_EDIT_INLINE",nodeRef:af.nodeRef,includeContent:true})}},onActionEditInlineSucess:function h(ah){if(!f.exists("response.item.node",ah)){this.alfLog("warn","When processing a request to display document properties, the expected 'response.item.node' attribute was not found",ah,this)}else{var ag=f.getObject("response.item.node",false,ah);var af=f.getObject("response.itemContent",false,ah);this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",{dialogTitle:"Edit: "+ag.properties["cm:name"],dialogConfirmationButtonTitle:"Save",dialogCancellationButtonTitle:"Cancel",formSubmissionTopic:"ALF_UPDATE_CONTENT_REQUEST",widgets:[{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"nodeRef",value:ag.nodeRef,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"prop_mimetype",value:ag.mimetype,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{name:"prop_app_editInline",value:true,visibilityConfig:{initialValue:false}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"Name",description:"The name to give the new document",name:"prop_cm_name",value:ag.properties["cm:name"],requirementConfig:{initialValue:true}}},{name:"alfresco/forms/controls/DojoValidationTextBox",config:{label:"Title",description:"The title to give to the new document",name:"prop_cm_title",value:ag.properties["cm:title"]}},{name:"alfresco/forms/controls/DojoTextarea",config:{label:"Description",description:"A description of the folder",name:"prop_cm_description",value:ag.properties["cm:description"]}},{name:"alfresco/forms/controls/AceEditor",config:{mimeType:ag.mimetype,label:"Content",description:"The content for the document",name:"prop_cm_content",value:af}}]})}},onActionEditOffline:function t(ai,af){af=(f.isArray(af))?af[0]:af;if(af!=null&&af.node!=null&&af.node.nodeRef!=null){var ah={nodeRef:af.node.nodeRef};var ag={url:A.PROXY_URI+"slingshot/doclib/action/checkout/node/"+ah.nodeRef.replace("://","/"),method:"POST",data:ah,successCallback:this.onActionEditOfflineSuccess,failureCallback:this.onActionEditOfflineFailure,callbackScope:this};this.serviceXhr(ag)}else{this.alfLog("error","A request was made to edit a document offline, but the document supplied does not contain enough information",af)}},onActionEditOfflineSuccess:function z(ag,af){this.alfLog("log","Edit offline request success",ag,af);if(ag!=null&&ag.results!=null&&ag.results.length>0&&ag.results[0].downloadUrl!=null){this.displayMessage(this.message("message.edit-offline.success",{"0":ag.results[0].id}));this.alfPublish(this.navigateToPageTopic,{url:A.PROXY_URI+ag.results[0].downloadUrl,type:this.fullPath});this.alfPublish(this.reloadDataTopic,{})}else{this.alfLog("error","A request to edit a document offline returned a successful response but did not provide a 'downloadUrl' attribute",ag,af)}},onActionEditOfflineFailure:function z(ag,af){this.alfLog("error","Edit offline request failure",ag,af);this.displayMessage(this.message("message.edit-offline.failure",{"0":ag.results[0].id}))},onActionCopyTo:function e(ag,af){this.createCopyMoveDialog(ag,af)},onActionMoveTo:function b(ag,af){this.createCopyMoveDialog(ag,af,{urlPrefix:this.moveAPI,dialogTitle:"services.ActionService.moveTo.title",confirmButtonLabel:"services.ActionService.moveTo.ok",singleItemMode:true})},createCopyMoveDialog:function aa(ap,am,ai){ai=ai||{};var aj=ai.urlPrefix||this.copyAPI,ag=ai.dialogTitle||"services.ActionService.copyTo.title",ao=ai.confirmButtonLabel||"services.ActionService.copyTo.ok",af=ai.singleItemMode||false;var al=this.generateUuid()+"_ALF_MOVE_LOCATION_PICKED",ah=a.nodeRefArray(am),an={nodes:ah,documents:am};var ak=(ah.length===1)?am[0].fileName:this.message("services.ActionService.copyMoveTo.multipleFiles");this._actionHandle=this.alfSubscribe(al,f.hitch(this,this.onCopyMoveLocationSelected,aj),true);this.alfPublish("ALF_CREATE_DIALOG_REQUEST",{dialogTitle:this.message(ag,{0:ak}),handleOverflow:false,widgetsContent:[{name:"alfresco/pickers/ContainerPicker",config:{singleItemMode:af,generatePubSubScope:true}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:ao,publishTopic:al,publishPayload:an,disableOnInvalidControls:true,validTopic:"ALF_PICKER_VALID",invalidTopic:"ALF_PICKER_INVALID"}},{name:"alfresco/buttons/AlfButton",config:{label:"picker.cancel.label",publishTopic:"NO_OP"}}]},true)},onCopyMoveLocationSelected:function q(ag,ai){this.alfUnsubscribeSaveHandles([this._actionCopyHandle]);var af=f.getObject("dialogContent.0.pickedItemsWidget.currentData.items",false,ai);var ah=f.getObject("documents",false,ai);if(af==null||af.length===0){this.alfLog("error","copyMoveTarget not specified")}else{if(ah==null||ah.length===0){this.alfLog("error","Documents to copy not specified.")}else{g.forEach(af,function(aj,al){var an=a.nodeRefArray(ah),ak=this.generateUuid(),am=this.alfSubscribe(ak+"_SUCCESS",f.hitch(this,this.onActionCopyToSuccess),true);this.serviceXhr({alfTopic:ak,subscriptionHandle:am,url:A.PROXY_URI+ag+aj.nodeRef.replace("://","/"),method:"POST",data:{nodeRefs:an,parentId:aj}})},this)}}},onActionCopyToSuccess:function J(af){this.onActionCompleteSuccess(arguments)},onActionDelete:function M(ai,ah){var af=this.generateUuid();this._actionDeleteHandle=this.alfSubscribe(af,f.hitch(this,this.onActionDeleteConfirmation),true);var ag=new Q({generatePubSubScope:false,title:this.message("delete-dialog.title"),widgetsContent:[{name:"alfresco/documentlibrary/views/AlfDocumentListView",config:{additionalCssClasses:"no-highlight",currentData:{items:ah},widgets:[{name:"alfresco/documentlibrary/views/layouts/Row",config:{widgets:[{name:"alfresco/documentlibrary/views/layouts/Cell",config:{widgets:[{name:"alfresco/renderers/SmallThumbnail"}]}},{name:"alfresco/documentlibrary/views/layouts/Cell",config:{widgets:[{name:"alfresco/renderers/Property",config:{propertyToRender:"node.properties.cm:name"}}]}}]}}]}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("services.ActionService.button.ok"),publishTopic:af,publishPayload:{nodes:ah,completionTopic:ai.completionTopic}}},{name:"alfresco/buttons/AlfButton",config:{label:this.message("services.ActionService.button.cancel"),publishTopic:"close"}}]});ag.show()},onActionDeleteConfirmation:function H(ah){this.alfUnsubscribeSaveHandles([this._actionDeleteHandle]);var ai=g.map(ah.nodes,function(aj){return aj.nodeRef});var af=this.generateUuid();var ag=this.alfSubscribe(af+"_SUCCESS",f.hitch(this,this.onActionDeleteSuccess),true);this.serviceXhr({alfTopic:af,subscriptionHandle:ag,url:A.PROXY_URI+"slingshot/doclib/action/files?alf_method=delete",method:"POST",data:{nodeRefs:ai}})},onActionDeleteSuccess:function X(af){this.onActionCompleteSuccess(arguments)},onActionCompleteSuccess:function F(ag){var af=f.getObject("requestConfig.subscriptionHandle",false,ag);if(af!=null){this.alfUnsubscribe(af)}this.alfPublish("ALF_DOCLIST_RELOAD_DATA",{})},onActionAssignWorkflow:function U(ai,ah){var aj=a.nodeRefsString(ah);var ag={selectedItems:aj};ag.destination=window.location.toString();var af=this.siteURL("start-workflow");this.alfPublish(this.postToPageTopic,{method:"POST",type:this.sharePageRelativePath,url:af,target:this.currentTarget,parameters:ag})},onActionFolderDownload:function j(ag,af){this.alfPublish("ALF_CREATE_DIALOG_REQUEST",{generatePubSubScope:true,dialogTitle:this.message("services.ActionService.ActionFolderDownload.title"),hideTopic:"ALF_CLOSE_DIALOG",widgetsContent:[{name:"alfresco/renderers/Progress",config:{requestProgressTopic:"ALF_ARCHIVE_REQUEST",progressFinishedTopic:["ALF_DOWNLOAD_FILE","ALF_ARCHIVE_DELETE"],nodes:af}}],widgetsButtons:[{name:"alfresco/buttons/AlfButton",config:{label:this.message("services.ActionService.button.cancel"),additionalCssClasses:"alfresco-dialogs-AlfProgress cancellation",publishTopic:"ALF_CLOSE_DIALOG"}}],handleOverflow:true},true)},createTemplateContent:function d(aj){var ai=aj.params.nodeRef,af=this._currentNode.parent.nodeRef;if(ai){var ah=A.PROXY_URI+"slingshot/doclib/node-templates",ag={parentNodeRef:af,sourceNodeRef:ai};this.serviceXhr({url:ah,node:ai,data:ag,method:"POST",successCallback:this.templateContentCreateSuccess,failureCallback:this.templateContentCreateFailure,callbackScope:this})}},templateContentCreateSuccess:function T(ag,af){this.displayMessage(this.message("message.create-content-by-template-node.success",ag.name));this.alfPublish("ALF_NODE_CREATED",{name:ag.name,parentNodeRef:af.data.parentNodeRef,highlightFile:ag.name})},templateContentCreateFailure:function T(ag,af){this.displayMessage(this.message("message.create-content-by-template-node.failure",ag.name))},onSyncLocation:function Z(ah){var ag=f.clone(this._currentNode.parent);var af={nodeRef:ag.nodeRef,displayName:ag.properties["cm:name"],jsNode:new l(ag)};this.callLegacyActionHandler("onActionCloudSync",af)},onUnsyncLocation:function o(ah){var ag=f.clone(this._currentNode.parent);var af={nodeRef:ag.nodeRef,displayName:ag.properties["cm:name"],jsNode:new l(ag)};this.callLegacyActionHandler("onActionCloudUnsync",af)},onMoveDocuments:function k(ai){if(ai&&ai.sourceNodeRefs!=null){var ag=null;if(ai.targetNodeRefUri!=null){ag=A.PROXY_URI+"slingshot/doclib/action/move-to/node/"+ai.targetNodeRefUri}else{if(ai.targetPath!=null){if(this.rootNode!=null){var ah=new l(this.rootNode).nodeRef.uri;ag=A.PROXY_URI+"slingshot/doclib/action/move-to/node/"+ah+ai.targetPath}else{ag=A.PROXY_URI+"slingshot/doclib/action/move-to/site/"+this.siteId+"/"+this.containerId+"/"+ai.targetPath}}}if(ag!=null){var af={nodeRefs:ai.sourceNodeRefs,parentId:this._currentNode.parent.nodeRef};this.serviceXhr({url:ag,data:af,method:"POST",successCallback:this.onMoveDocumentsSuccess,failureCallback:this.onMoveDocumentsFailure,callbackScope:this})}else{this.alfLog("warn","Could not process a request to move documents due to missing attributes, either 'targetNodeRefUri' or 'targetPath' is required",ai)}}},onMoveDocumentsSuccess:function V(ag,af){this.alfPublish(this.reloadDataTopic,{})},onMoveDocumentsFailure:function V(ag,af){}})});