define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/CoreXhr","service/constants/Default","alfresco/documentlibrary/_AlfDocumentListTopicMixin","dojo/_base/lang","alfresco/core/NodeUtils","alfresco/dialogs/AlfFormDialog"],function(j,c,d,e,h,b,l,m){return j([c,d,h],{i18nScope:"Alfresco.DocListToolbar",i18nRequirements:[{i18nFile:"../../../WEB-INF/classes/alfresco/site-webscripts/org/alfresco/components/documentlibrary/toolbar.get.properties"}],constructor:function p(r){b.mixin(this,r);this.alfSubscribe("ALF_CURRENT_NODEREF_CHANGED",b.hitch(this,this.handleCurrentNodeChange));this.alfSubscribe("ALF_SHOW_UPLOADER",b.hitch(this,this.showUploader));this.alfSubscribe("ALF_CONTENT_SERVICE_UPLOAD_REQUEST_RECEIVED",b.hitch(this,this.onFileUploadRequest));this.alfSubscribe("ALF_CREATE_NEW_FOLDER",b.hitch(this,this.createNewFolder));this.alfSubscribe("ALF_CREATE_CONTENT_REQUEST",b.hitch(this,this.onCreateContent));this.alfSubscribe("ALF_UPDATE_CONTENT_REQUEST",b.hitch(this,this.onUpdateContent))},onCreateContent:function o(t){if(t.alf_destination==null||t.alf_destination===""){t.alf_destination=this._currentNode.parent.nodeRef}var s=null;if(t.type==null){s="cm%3acontent"}else{s=t.type}var r=e.PROXY_URI+"api/type/"+s+"/formprocessor";this.serviceXhr({url:r,data:t,method:"POST",successCallback:this.contentCreationSuccess,callbackScope:this})},onUpdateContent:function a(t){if(t.nodeRef==null){this.alfLog("warn","A request was made to update content but no 'nodeRef' attribute was provided",t,this)}else{var s=l.processNodeRef(t.nodeRef);var r=e.PROXY_URI+"api/node/"+s.uri+"/formprocessor";delete t.nodeRef;this.serviceXhr({url:r,data:t,method:"POST",successCallback:this.contentCreationSuccess,callbackScope:this})}},contentCreationSuccess:function i(s,r){this.alfPublish(this.reloadDataTopic,{})},_currentNode:null,handleCurrentNodeChange:function g(r){if(r&&r.node){this.alfLog("log","Updating current nodeRef to: ",r.node);this._currentNode=r.node}else{this.alfLog("error","A request was made to update the current NodeRef, but no 'node' property was provided in the payload: ",r)}},showUploader:function n(r){this.uploadDialog=new m({dialogTitle:"Select files to upload",dialogConfirmationButtonTitle:"Upload",dialogCancellationButtonTitle:"Cancel",formSubmissionTopic:"ALF_CONTENT_SERVICE_UPLOAD_REQUEST_RECEIVED",formSubmissionPayload:{targetData:{destination:this._currentNode.parent.nodeRef,siteId:null,containerId:null,uploadDirectory:null,updateNodeRef:null,description:"",overwrite:false,thumbnails:"doclib",username:null}},widgets:[{name:"alfresco/forms/controls/FileSelect",config:{label:"Select files to upload...",name:"files"}}]});this.uploadDialog.show()},onFileUploadRequest:function k(s){if(this.uploadDialog!=null){this.uploadDialog.destroyRecursive()}var r=this.generateUuid();this._uploadSubHandle=this.alfSubscribe(r,b.hitch(this,"onFileUploadComplete"),true);s.alfResponseTopic=r;this.alfPublish("ALF_UPLOAD_REQUEST",s)},onFileUploadComplete:function f(){this.alfLog("log","Upload complete");this.alfUnsubscribeSaveHandles([this._uploadSubHandle]);this.alfPublish(this.reloadDataTopic,{})},createNewFolder:function q(x){var r=this._currentNode.parent.nodeRef;var t=function y(z,A){Dom.get(A.id+"-dialogTitle").innerHTML=this.message("label.new-folder.title");Dom.get(A.id+"-dialogHeader").innerHTML=this.message("label.new-folder.header")};var w=YAHOO.lang.substitute(e.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&formId={formId}&showCancelButton=true",{itemKind:"type",itemId:"cm:folder",destination:r,mode:"create",submitType:"json",formId:"doclib-common"});var u=new Alfresco.module.SimpleDialog(this.id+"-createFolder");u.setOptions({width:"33em",templateUrl:w,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:t,scope:this},onSuccess:{fn:function v(A){var B;var C=A.config.dataObj.prop_cm_name;var z=A.json.persistedObject;YAHOO.Bubbling.fire("folderCreated",{name:C,parentNodeRef:r});this.alfPublish(this.reloadDataTopic,{});Alfresco.util.PopupManager.displayMessage({text:this.message("message.new-folder.success",{"0":C})})},scope:this},onFailure:{fn:function s(z){if(z){var A=z.config.dataObj.prop_cm_name;Alfresco.util.PopupManager.displayMessage({text:this.message("message.new-folder.failure",{"0":A})})}else{Alfresco.util.PopupManager.displayMessage({text:this.message("message.failure")})}},scope:this}}).show()}})});