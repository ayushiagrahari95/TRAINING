define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/Preview.html","alfresco/core/Core","alfresco/core/CoreXhr","service/constants/Default","alfresco/core/Page","dojo/dom-construct","dojo/_base/lang","dojo/_base/array","dojo/json","dojo/query","dojo/NodeList-manipulate"],function(p,m,h,r,n,f,j,k,d,s,g,o,c){return p([m,h,n,f],{cssRequirements:[{cssFile:"./css/Preview.css"}],i18nRequirements:[{i18nFile:"./i18n/Preview.properties"}],templateString:r,postCreate:function b(){this.alfSubscribe("ALF_GENERATE_PAGE_PREVIEW",s.hitch(this,"generatePreview"))},getPageDefinitionFromPayload:function e(u){var t={};if(u.pageDefinition==null){t={publishOnReady:u.publishOnReady.widgetsConfig,publishOnReadyEditorConfig:u.publishOnReady.editorConfig,services:u.services.widgetsConfig,servicesEditorConfig:u.services.editorConfig,widgets:u.widgets.widgetsConfig,widgetsEditorConfig:u.widgets.editorConfig};t=o.stringify(t)}else{t=u.pageDefinition}return t},generatePreview:function q(x){if(x!=null){if(this.rootPreviewWidget!=null){this.rootPreviewWidget.destroyRecursive(false)}try{var v=this.getPageDefinitionFromPayload(x);var t=o.parse(v);var u={jsonContent:t,widgets:v};this.serviceXhr({url:j.URL_SERVICECONTEXT+"surf/dojo/xhr/dependencies",data:u,method:"POST",successCallback:this.updatePage,failureCallback:this.onDependencyFailure,callbackScope:this})}catch(w){this.alfLog("error","An error occurred parsing the JSON",w,this)}}else{this.alfLog("warn","A request was made to preview a page definition, but no 'pageDefinition' was provided",x,this)}},updatePage:function l(u,t){for(var x in u.cssMap){c("head").append('<link rel="stylesheet" type="text/css" href="'+appContext+u.cssMap[x]+'" media="'+x+'">')}for(var w in u.i18nMap){if(typeof window[u.i18nGlobalObject].messages.scope[w]=="undefined"){window[u.i18nGlobalObject].messages.scope[w]=u.i18nMap[w]}else{s.mixin(window[u.i18nGlobalObject].messages.scope[w],u.i18nMap[w])}}var v=[];g.forEach(u.nonAmdDeps,function(z,y){v.push(j.URL_RESCONTEXT+z)});v.push(j.URL_RESCONTEXT+u.javaScript);require(v,s.hitch(this,"buildPreview",t.data.jsonContent,this.previewNode))},rootPreviewWidget:null,buildPreview:function a(u,t){var v=d.create("div",{},t);this.rootPreviewWidget=new k({widgets:u.widgets,services:u.services,publishOnReady:u.publishOnReady},v)},onDependencyFailure:function i(u,t){this.alfLog("error","An error occurred requesting the XHR dependencies",u,t)}})});