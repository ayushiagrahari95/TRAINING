define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/SearchBox.html","dojo/text!./templates/LiveSearch.html","dojo/text!./templates/LiveSearchItem.html","alfresco/core/Core","alfresco/core/CoreXhr","alfresco/header/AlfMenuBar","service/constants/Default","dojo/json","dojo/dom-attr","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/date/stamp","dojo/on"],function(d,e,f,n,m,a,c,J,q,w,k,v,h,G,t,H,y,K,z){var s=d([n,m,q],{i18nScope:"org.alfresco.SearchBox",searchBox:null,containerNodeDocs:null,containerNodeSites:null,containerNodePeople:null,label:null,templateString:c,postMixInProperties:function E(){this.label={};f.forEach(["documents","sites","people","more"],e.hitch(this,function(M){this.label[M]=this.message("search."+M)}))},onSearchDocsMoreClick:function A(M){this.searchBox.liveSearchDocuments(this.searchBox.lastSearchText,this.searchBox.resultsCounts.docs);M.preventDefault()}});var I=d([n,m,q],{searchBox:null,templateString:J,onResultClick:function o(M){this.searchBox.onSaveLastUserSearch()}});return d([n,m,q,w],{nonAmdDependencies:["/js/alfresco.js"],i18nScope:"org.alfresco.SearchBox",cssRequirements:[{cssFile:"./css/SearchBox.css"}],i18nRequirements:[{i18nFile:"./i18n/SearchBox.properties"}],templateString:a,_searchMenu:null,_width:"180",site:null,advancedSearch:true,allsites:false,liveSearch:true,lastSearchText:null,_keyRepeatWait:250,_minimumSearchLength:2,_resultPageSize:5,_LiveSearch:null,_requests:null,_lastSearchIndex:0,resultsCounts:null,postMixInProperties:function j(){this.label={};f.forEach(["clear"],e.hitch(this,function(M){this.label[M]=this.message("search."+M)}))},postCreate:function x(){this._requests=[];this.resultsCounts={};G.set(this._searchTextNode,"id","HEADER_SEARCHBOX_FORM_FIELD");G.set(this._searchTextNode,"placeholder",this.message("search.instruction"));z(this._searchTextNode,"keyup",e.hitch(this,function(N){this.onSearchBoxKeyUp(N)}));z(this._searchTextNode,"keydown",e.hitch(this,function(N){this.onSearchBoxKeyDown(N)}));if(this.advancedSearch){var M=e.getObject("Alfresco.constants.SITE");this._searchMenu=new k({widgets:[{name:"alfresco/header/AlfMenuBarPopup",config:{id:this.id+"_DROPDOWN_MENU",showArrow:false,label:"",iconSrc:"js/alfresco/header/css/images/search-16-gray.png",iconClass:"alf-search-icon",widgets:[{name:"alfresco/menus/AlfMenuItem",config:{id:this.id+"_ADVANCED_SEARCH",i18nScope:"org.alfresco.SearchBox",label:"search.advanced",targetUrl:(M?"site/"+M+"/":"")+"advsearch"}}]}}]});this._searchMenu.placeAt(this._searchMenuNode);this._searchMenu.startup()}if(this.liveSearch){this._LiveSearch=new s({searchBox:this});this._LiveSearch.placeAt(this._searchLiveNode);z(window,"click",e.hitch(this,function(N){t.set(this._LiveSearch.containerNode,"display","none")}));z(this._searchTextNode,"click",e.hitch(this,function(N){this.updateResults();N.stopPropagation()}));z(this._LiveSearch,"click",function(N){N.stopPropagation()})}this.addAccessibilityLabel()},linkToFacetedSearch:true,generateSearchPageLink:function r(N){var M;if(this.linkToFacetedSearch===true){M="dp/ws/faceted-search#searchTerm="+encodeURIComponent(N)+"&scope=repo&sortField=Relevance";if(this.site!=null){M="site/"+this.site+"/"+M}}else{M="search?t="+encodeURIComponent(N)+(this.allsites?"&a=true&r=false":"&a=false&r=true");if(this.site!=null){M="site/"+this.site+"/"+M}}this.alfLog("log","Generated search page link",M,this);return M},_supportsLocalStorage:function C(){try{return"localStorage" in window&&window.localStorage!==null}catch(M){return false}},onSaveLastUserSearch:function g(){var N=e.trim(this._searchTextNode.value);if(N.length!==0){if(this._supportsLocalStorage()){var M=h.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"))||[];if(M.length===0||M[M.length-1]!==N){M.push(N);if(M.length>16){M=M.slice(M.length-16)}localStorage.setItem("ALF_SEARCHBOX_HISTORY",h.stringify(M))}}}},onSearchBoxKeyDown:function b(M){switch(M.keyCode){case 37:case 39:M.stopPropagation();break;case 38:M.stopPropagation();if(this._supportsLocalStorage()){var N=h.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"));if(N){if(this._lastSearchIndex===0){this._lastSearchIndex=N.length-1}else{this._lastSearchIndex--}this._searchTextNode.value=N[this._lastSearchIndex];this.onSearchBoxKeyUp(M)}}break;case 40:M.stopPropagation();if(this._supportsLocalStorage()){var N=h.parse(localStorage.getItem("ALF_SEARCHBOX_HISTORY"));if(N){if(this._lastSearchIndex===N.length-1){this._lastSearchIndex=0}else{this._lastSearchIndex++}this._searchTextNode.value=N[this._lastSearchIndex];this.onSearchBoxKeyUp(M)}}break}},onSearchBoxKeyUp:function L(M){var P=e.trim(this._searchTextNode.value);switch(M.keyCode){case 13:if(P.length!==0){this.onSaveLastUserSearch();this.clearResults();this.alfLog("log","Search request for: ",P);var N=this.generateSearchPageLink(P);this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:N,type:"SHARE_PAGE_RELATIVE",target:"CURRENT"})}break;default:if(this.liveSearch){if(P.length>=this._minimumSearchLength&&P!==this.lastSearchText){this.lastSearchText=P;for(var O=0;O<this._requests.length;O++){this._requests[O].cancel()}this._requests=[];if(this._timeoutHandle){clearTimeout(this._timeoutHandle)}var Q=this;this._timeoutHandle=setTimeout(function(){Q.liveSearchDocuments(P,0);Q.liveSearchSites(P,0);Q.liveSearchPeople(P,0)},this._keyRepeatWait)}}if(P.length===0){this.clearResults()}}},liveSearchDocuments:function u(M,N){this._requests.push(this.serviceXhr({url:v.PROXY_URI+"slingshot/live-search-docs?t="+encodeURIComponent(M)+"&maxResults="+this._resultPageSize+"&startIndex="+N,method:"GET",successCallback:function(O){if(N===0){this._LiveSearch.containerNodeDocs.innerHTML=""}f.forEach(O.items,function(R){var P=(R.site?"site/"+R.site.shortName+"/":"");var S="";if(R.site){S+="<a href='"+v.URL_PAGECONTEXT+P+"documentlibrary'>"+this.encodeHTML(R.site.title)+"</a> | "}S+="<a href='"+v.URL_PAGECONTEXT+"user/"+this.encodeHTML(R.modifiedBy)+"/profile'>"+this.encodeHTML(R.modifiedBy)+"</a> | ";S+=Alfresco.util.relativeTime(R.modifiedOn)+" | ";S+=Alfresco.util.formatFileSize(R.size);var T=this.encodeHTML(R.title);if(R.description){T+=(T.length!==0?"\r\n":"")+this.encodeHTML(R.description)}var Q;switch(R.container){case"wiki":Q="wiki-page?title="+encodeURIComponent(R.name);break;case"blog":Q="blog-postview?postId="+encodeURIComponent(R.name);R.name=R.title;break;default:Q="document-details?nodeRef="+R.nodeRef;break}var U=new I({searchBox:this,cssClass:"alf-livesearch-thumbnail",title:T,label:this.encodeHTML(R.name),link:v.URL_PAGECONTEXT+P+Q,icon:v.PROXY_URI+"api/node/"+R.nodeRef.replace(":/","")+"/content/thumbnails/doclib?c=queue&ph=true&lastModified="+(R.lastThumbnailModification||1),alt:this.encodeHTML(R.name),meta:S});U.placeAt(this._LiveSearch.containerNodeDocs)},this);t.set(this._LiveSearch.nodeDocsMore,"display",O.hasMoreRecords?"block":"none");if(N===0){this.resultsCounts.docs=0}this.resultsCounts.docs+=O.items.length;this.updateResults()},failureCallback:function(O){t.set(this._LiveSearch.nodeDocsMore,"display","none");if(N===0){this._LiveSearch.containerNodeDocs.innerHTML="";this.resultsCounts.docs=0}this.updateResults()},callbackScope:this}))},liveSearchSites:function F(M,N){this._requests.push(this.serviceXhr({url:v.PROXY_URI+"slingshot/live-search-sites?t="+encodeURIComponent(M)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(O){this._LiveSearch.containerNodeSites.innerHTML="";f.forEach(O.items,function(P){var Q=new I({searchBox:this,cssClass:"alf-livesearch-icon",title:this.encodeHTML(P.description),label:this.encodeHTML(P.title),link:v.URL_PAGECONTEXT+"site/"+P.shortName+"/dashboard",icon:v.URL_RESCONTEXT+"components/images/filetypes/generic-site-32.png",alt:this.encodeHTML(P.title),meta:P.description?this.encodeHTML(P.description):"&nbsp;"});Q.placeAt(this._LiveSearch.containerNodeSites)},this);this.resultsCounts.sites=O.items.length;this.updateResults()},failureCallback:function(O){this._LiveSearch.containerNodeSites.innerHTML="";this.resultsCounts.sites=0;this.updateResults()},callbackScope:this}))},liveSearchPeople:function B(M,N){this._requests.push(this.serviceXhr({url:v.PROXY_URI+"slingshot/live-search-people?t="+encodeURIComponent(M)+"&maxResults="+this._resultPageSize,method:"GET",successCallback:function(O){this._LiveSearch.containerNodePeople.innerHTML="";f.forEach(O.items,function(P){var R=P.firstName+" "+P.lastName;var Q=this.encodeHTML(P.jobtitle||"")+(P.location?(", "+this.encodeHTML(P.location)):"");var S=new I({searchBox:this,cssClass:"alf-livesearch-icon",title:this.encodeHTML(P.jobtitle||""),label:this.encodeHTML(R+" ("+P.userName+")"),link:v.URL_PAGECONTEXT+"user/"+encodeURIComponent(P.userName)+"/profile",icon:v.PROXY_URI+"slingshot/profile/avatar/"+encodeURIComponent(P.userName)+"/thumbnail/avatar32",alt:this.encodeHTML(R),meta:Q?Q:"&nbsp;"});S.placeAt(this._LiveSearch.containerNodePeople)},this);this.resultsCounts.people=O.items.length;this.updateResults()},failureCallback:function(O){this._LiveSearch.containerNodePeople.innerHTML="";this.resultsCounts.people=0;this.updateResults()},callbackScope:this}))},updateResults:function l(){var M=false;if(this.resultsCounts.docs>0){M=true;t.set(this._LiveSearch.titleNodeDocs,"display","block");t.set(this._LiveSearch.containerNodeDocs,"display","block")}else{t.set(this._LiveSearch.titleNodeDocs,"display","none");t.set(this._LiveSearch.containerNodeDocs,"display","none")}if(this.resultsCounts.sites>0){M=true;t.set(this._LiveSearch.titleNodeSites,"display","block");t.set(this._LiveSearch.containerNodeSites,"display","block")}else{t.set(this._LiveSearch.titleNodeSites,"display","none");t.set(this._LiveSearch.containerNodeSites,"display","none")}if(this.resultsCounts.people>0){M=true;t.set(this._LiveSearch.titleNodePeople,"display","block");t.set(this._LiveSearch.containerNodePeople,"display","block")}else{t.set(this._LiveSearch.titleNodePeople,"display","none");t.set(this._LiveSearch.containerNodePeople,"display","none")}if(M){t.set(this._LiveSearch.containerNode,"display","block")}else{t.set(this._LiveSearch.containerNode,"display","none")}},clearResults:function i(){this._searchTextNode.value="";if(this.liveSearch){this.lastSearchText="";for(var M=0;M<this._requests.length;M++){this._requests[M].cancel()}this._requests=[];this.resultsCounts={};this._LiveSearch.containerNodeDocs.innerHTML="";this._LiveSearch.containerNodePeople.innerHTML="";this._LiveSearch.containerNodeSites.innerHTML="";t.set(this._LiveSearch.nodeDocsMore,"display","none");this.updateResults()}this._searchTextNode.focus()},addAccessibilityLabel:function p(){y.create("label",{"for":"HEADER_SEARCHBOX_FORM_FIELD",innerHTML:this.message("search.label"),"class":"hidden"},this._searchTextNode,"before")},onSearchClearClick:function D(M){this.clearResults();M.preventDefault()}})});