define(["dojo/_base/declare","service/constants/Default","dijit/registry","dojo/topic","dojo/_base/array","dojo/_base/lang","dojo/dom-construct","dojox/uuid/generateRandomUuid","dojo/request/xhr","dojo/json","dojo/date/stamp","dojo/cookie"],function(w,l,i,d,h,x,f,u,j,b,q,v){return w(null,{constructor:function(y){x.mixin(this,y);this.csrfProperties=l.CSRF_POLICY.properties||{};this.serviceRequests={}},cleanupJSONResponse:function r(y){var z=y;if(typeof y=="string"){z=y.replace(/,}/g,"}")}return z},serviceXhr:function c(y){var D=this;if(y){if(typeof y.url=="undefined"){this.alfLog("error","An XHR request was made but no URL was provided",y)}else{var C=(y.headers)?y.headers:{"Content-Type":"application/json"};if(this.isCsrfFilterEnabled()){C[this.getCsrfHeader()]=this.getCsrfToken()}var A;if(C["Content-Type"]=="application/json"){try{A=(y.data!=null)?b.stringify(y.data):null}catch(B){this.alfLog("warn","Could not stringify XHR JSON data",A);A=null}}else{A=y.data}var z=j(y.url,{handleAs:(y.handleAs)?y.handleAs:"text",method:(y.method)?y.method:"POST",data:A,query:(y.query)?y.query:null,headers:C}).then(function(F){var H=x.getObject("requestId",false,y);if(H!=null){delete D.serviceRequests[H]}if(typeof F=="string"&&x.trim(F)!==""){try{F=b.parse(D.cleanupJSONResponse(F))}catch(G){D.alfLog("error","An error occurred parsing an XHR JSON success response",F,this)}}if(typeof y.successCallback=="function"){var E=(y.successCallbackScope?y.successCallbackScope:(y.callbackScope?y.callbackScope:D));y.successCallback.call(E,F,y)}else{D.defaultSuccessCallback(F,y)}},function(F){if(F.response&&F.response.status===401){var I=F.response.getHeader("Location");if(I){if(I.indexOf("http://")==0||I.indexOf("https://")==0){window.location.href=I}else{window.location.href=window.location.protocol+"//"+window.location.host+I}return}else{window.location.reload(true);return}}var H=x.getObject("requestId",false,y);if(H!=null){delete D.serviceRequests[H]}if(typeof F=="string"&&x.trim(F)!==""){try{F=b.parse(D.cleanupJSONResponse(F))}catch(G){D.alfLog("error","An error occurred parsing an XHR JSON failure response",F,this)}}if(typeof y.failureCallback=="function"){var E=(y.failureCallbackScope?y.failureCallbackScope:(y.callbackScope?y.callbackScope:D));y.failureCallback.call(E,F,y)}else{D.defaultFailureCallback(F,y)}},function(F){if(typeof F=="string"&&x.trim(F)!==""){try{F=b.parse(D.cleanupJSONResponse(F))}catch(G){D.alfLog("error","An error occurred parsing an XHR JSON progress response",F,this)}}if(typeof y.progressCallback=="function"){var E=(y.progressCallbackScope?y.progressCallbackScope:(y.callbackScope?y.callbackScope:D));y.progressCallback.call(E,F,y)}else{D.defaultProgressCallback(F,y)}});if(y.requestId){this.serviceRequests[y.requestId]=z}return z}}else{this.alfLog("error","A request was made to perform an XHR request, but no configuration for the request was provided")}},defaultSuccessCallback:function m(z,y){this.alfLog("log","[DEFAULT CALLBACK] The following successful response was received",z,y);if(y.alfTopic){this.alfPublish(y.alfTopic+"_SUCCESS",{requestConfig:y,response:z})}},defaultFailureCallback:function n(A,y){this.alfLog("log","[DEFAULT CALLBACK] The following failure response was received",A,y);if(y.alfTopic){this.alfPublish(y.alfTopic+"_FAILURE",{requestConfig:y,response:A})}if(typeof this.displayMessage==="function"&&A.response.text){try{var z=b.parse(A.response.text);if(z.message){var D=z.message;var C=D.indexOf("Exception: ");if(C!==-1&&D.length>C+20){D=D.substring(C+20)}this.displayMessage(D)}}catch(B){}}},defaultProgressCallback:function g(z,y){this.alfLog("log","[DEFAULT CALLBACK] The following progress response was received",z,y);if(y.alfTopic){this.alfPublish(y.alfTopic+"_PROGRESS",{requestConfig:y,response:z})}},onStopRequest:function p(y){var z=x.getObject("requestId",false,y);if(z!=null&&this.serviceRequests[z]){this.alfLog("info","Stopping XHR request: "+z);this.serviceRequests[z].cancel();delete this.serviceRequests[z]}},isCsrfFilterEnabled:function t(){return l.CSRF_POLICY.enabled},getCsrfHeader:function k(){return this.csrfResolve(l.CSRF_POLICY.header)},getCsrfParameter:function e(){return this.csrfResolve(l.CSRF_POLICY.parameter)},getCsrfCookie:function o(){return this.csrfResolve(l.CSRF_POLICY.cookie)},getCsrfToken:function s(){var y=null;var z=this.getCsrfCookie();if(z){y=v(z);if(y){y=y.replace(/"/g,"")}}return y},csrfResolve:function a(y){return x.replace(y,this.csrfProperties)}})});