define(["dojo/_base/declare","alfresco/core/Core","alfresco/core/ObjectTypeUtils","dijit/registry","dojo/_base/array","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-style","service/constants/Default","alfresco/debug/WidgetInfo"],function(v,q,r,l,k,A,h,n,s,o,m){return v([q],{processWidgets:function u(C,B){try{if(C&&C instanceof Array){this.widgetProcessingComplete=false;this._processedWidgetCountdown=C.length;this._processedWidgets=[];k.forEach(C,A.hitch(this,this.processWidget,B))}}catch(D){this.alfLog("error","The following error occurred processing widgets",D)}},processWidget:function j(B,E,C){if(E!=null){if(this.filterWidget(E,C)){var D=this.createWidgetDomNode(E,B,(E.className!=null?E.className:""));this.createWidget(E,D,this._registerProcessedWidget,this,C)}}else{this.alfLog("warn","Could not process widget because it was missing configuration - check 'widgets' array for empty elements",this,C);this._processedWidgetCountdown--}},_processedWidgets:null,_processedWidgetCountdown:null,_registerProcessedWidget:function d(C,B){this._processedWidgetCountdown--;this.alfLog("log","Widgets expected: ",this._processedWidgetCountdown,this.id);if(C!=null){if(this._processedWidgets==null){this._processedWidgets=[]}if(B==null||isNaN(B)){this._processedWidgets.push(C)}else{this._processedWidgets[B]=C}this.setupVisibilityConfigProcessing(C,false);this.setupVisibilityConfigProcessing(C,true)}else{this.alfLog("warn","No widget supplied following registration",this)}if(this._processedWidgetCountdown===0){this._processedWidgets=k.filter(this._processedWidgets,function(D){return D!=null},this);this.allWidgetsProcessed(this._processedWidgets);this.widgetProcessingComplete=true}},setupVisibilityConfigProcessing:function p(D,E){E=(E!=null)?E:false;var C=E?"invisibilityConfig":"visibilityConfig";if(D[C]!==undefined){var B=A.getObject(C+".initialValue",false,D);B=E?!B:B;if(B!=null&&B===false){s.set(D.domNode,"display","none")}var F=A.getObject(C+".rules",false,D);if(F!=null){k.forEach(F,function(N,J){var I=N.topic,L=N.attribute,K=N.is,H=N.isNot,G=N.strict!=null?N.strict:true,M=N.useCurrentItem!=null?N.useCurrentItem:false;if(I!=null&&L!=null&&(K!=null||H!=null)){D.alfSubscribe(I,A.hitch(this,"processVisibility",D,K,H,L,E,G,M))}},this)}}},processVisibility:function i(F,G,C,B,E,K,J,L){var H=A.getObject(B,false,L);var M=(typeof G=="undefined"||G.length===0);var I=(typeof C!="undefined"&&C.length>0);if(I){I=k.some(C,A.hitch(this,"visibilityRuleComparator",H,F,J))}if(!I&&typeof G!="undefined"&&G.length>0){M=k.some(G,A.hitch(this,"visibilityRuleComparator",H,F,J))}var D=M&&!I;if(D){if(E){s.set(F.domNode,"display","none")}else{s.set(F.domNode,"display","");if(typeof F.alfPublishResizeEvent==="function"){F.alfPublishResizeEvent(F.domNode)}}}else{if(K){if(E){s.set(F.domNode,"display","");if(typeof F.alfPublishResizeEvent==="function"){F.alfPublishResizeEvent(F.domNode)}}else{s.set(F.domNode,"display","none")}}}},visibilityRuleComparator:function g(C,D,E,B){if(C==null&&B==null){return true}else{if(C!=null&&typeof C.toString=="function"&&B!=null&&typeof B.toString=="function"){if(E===true&&D.currentItem!=null){var F=A.getObject(B.toString(),false,D.currentItem);return F==C.toString()}else{return B.toString()==C.toString()}}else{return false}}},widgetProcessingComplete:false,allWidgetsProcessed:function b(B){this.alfLog("log","All widgets processed")},createWidgetDomNode:function x(E,C,B){var D=C;if(B!=null&&B!==""){D=h.create("div",{className:B},C)}return h.create("div",{},D)},createWidget:function w(C,D,I,K,G){try{var F=this;this.alfLog("log","Creating widget: ",C);var B=(C&&C.config&&(typeof C.config==="object"))?C.config:{};if(typeof B.id=="undefined"){if(C.id==null||A.trim(C.id)===""){B.id=C.name.replace(/\//g,"_")+"___"+this.generateUuid()}else{B.id=C.id}}if(B.generatePubSubScope===true){B.pubSubScope=this.generateUuid()}else{if(B.pubSubScope===undefined){B.pubSubScope=this.pubSubScope}}if(B.pubSubScope==this.pubSubScope){if(!this.parentPubSubScope){B.parentPubSubScope=""}else{B.parentPubSubScope=this.parentPubSubScope}}else{B.parentPubSubScope=this.pubSubScope}if(B.dataScope===undefined){B.dataScope=this.dataScope}if(B.currentItem===undefined){B.currentItem=this.currentItem}if(B.currentMetadata===undefined){B.currentMetadata=this.currentMetadata}if(B.groupMemberships===undefined){B.groupMemberships=this.groupMemberships}var E=null;var J=[C.name];require(J,function(L){if(l.byId(B.id)!=null){B.id=C.name+"___"+F.generateUuid()}E=new L(B,D);if(F.widgetsToDestroy==null){F.widgetsToDestroy=[];F.widgetsToDestroy.push(E)}F.alfLog("log","Created widget",E);E.startup();if(C.assignTo!=null){F[C.assignTo]=E}if(B.style!=null&&E.domNode!=null){s.set(E.domNode,B.style)}if(o.DEBUG&&E.domNode!=null){n.add(E.domNode,"alfresco-debug-Info highlight");var M=new m({displayId:C.id||"",displayType:C.name,displayConfig:B}).placeAt(E.domNode);h.place(M.domNode,E.domNode,"first")}if(I){I.call((K!=null?K:this),E,G)}});if(E==null){this.alfLog("warn","A widget was not declared so that it's modules were included in the loader cache",C,this)}return E}catch(H){this.alfLog("error","The following error occurred creating a widget",H,this);if(I){I.call((K!=null?K:this),null,G)}return null}},filterWidget:function z(G,B,C){var F=true;if(G.config!=null&&G.config.renderFilter!=null){var E=G.config.renderFilter;if(!r.isArray(E)){this.alfLog("warn","A request was made to filter a widget, but the filter configuration was not an array",this,G);F=true}else{var D=A.getObject("config.renderFilterMethod",false,G);if(D==null||A.trim(D)=="ALL"){F=k.every(E,A.hitch(this,this.processFilterConfig))}else{F=k.some(E,A.hitch(this,this.processFilterConfig))}}}else{}if(!F&&C!==false){this._registerProcessedWidget(null,B)}return F},processFilterConfig:function t(F,C){var B=false;if(this.filterPropertyExists(F)){var D=this.getRenderFilterPropertyValue(F),E=this.getRenderFilterValues(F);B=k.some(E,A.hitch(this,"processFilter",F,D))}else{if(F.renderOnAbsentProperty===true){B=true}else{B=false}}if(F.negate==null||F.negate===false){}else{B=!B}this.alfLog("log","Render filter result",B,this.currentItem,F);return B},processFilter:function c(D,C,B){if(r.isString(B)){B=A.trim(B)}if(typeof C==="boolean"){C=C.toString()}if(typeof B==="boolean"){B=B.toString()}return B===C},filterPropertyExists:function y(C){var B=this.currentItem;if(C.target!=null&&this[C.target]!=null){B=this[C.target]}return(r.isString(C.property)&&r.isObject(B)&&A.exists(C.property,B))},getRenderFilterPropertyValue:function a(C){var B=this.currentItem;if(C.target!=null&&this[C.target]!=null){B=this[C.target]}return A.getObject(C.property,false,B)},getCustomRenderFilterProperty:function e(C){var B=null;if(C instanceof Boolean||typeof C=="boolean"){B=C?"folder":"document"}return B},getRenderFilterValues:function f(C){var B=null;if(r.isArray(C.values)){B=C.values}else{if(r.isString(C.values)){B=[C.values]}else{B=[]}}return B}})});