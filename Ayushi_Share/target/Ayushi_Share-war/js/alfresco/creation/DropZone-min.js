define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/DropZone.html","alfresco/core/Core","dojo/_base/lang","dojo/_base/array","dijit/registry","dojo/dnd/Source","dojo/dnd/Target","dojo/dom-construct","dojo/dom-class","dojo/aspect","alfresco/creation/DropZoneWrapper","dojo/on"],function(w,n,i,y,o,z,g,h,q,v,f,j,r,d,l){return w([n,i,o],{cssRequirements:[{cssFile:"./css/DropZone.css"}],templateString:y,horizontal:false,previewTarget:null,initialItems:null,acceptTypes:null,postCreate:function b(){if(this.acceptTypes==null){this.acceptTypes=["widget"]}this.previewTarget=new q(this.previewNode,{accept:this.acceptTypes,creator:z.hitch(this,"creator"),withHandles:true,horizontal:this.horizontal});this.childPubSubScope=this.generateUuid();r.after(this.previewTarget,"onMouseDown",z.hitch(this,"onWidgetSelected"),true);r.after(this.previewTarget,"onDrop",z.hitch(this,"refreshChildren"),true);r.after(this.previewTarget,"insertNodes",z.hitch(this,"publishAvailableFields"),true);this.alfSubscribe("ALF_UPDATE_RENDERED_WIDGET",z.hitch(this,"updateItem"));this.alfSubscribe(this.childPubSubScope+"ALF_REQUEST_AVAILABLE_FORM_FIELDS",z.hitch(this,"publishAvailableFields"),true);l(this.previewNode,"onWidgetDelete",z.hitch(this,"deleteItem"));if(this.initialItems!=null){this.previewTarget.insertNodes(false,this.initialItems,false,null)}if(this.value!=null&&this.value!==""){g.forEach(this.value,function(C,A){var B={name:C.name,module:C.module,defaultConfig:C.defaultConfig,widgetsForDisplay:C.widgetsForDisplay,widgetsForConfig:C.widgetsForConfig};var D=this.creator(B);this.previewTarget.insertNodes(true,[D.data])},this)}},getAvailableFields:function u(){var D=[];for(var B in this.previewTarget.map){var C=this.previewTarget.map[B];var E=z.getObject("updatedConfig.defaultConfig.name",false,C.data);if(E==null){E=z.getObject("defaultConfig.name",false,C.data)}var A=z.getObject("updatedConfig.defaultConfig.fieldId",false,C.data);if(A==null){A=z.getObject("defaultConfig.fieldId",false,C.data)}D.push({label:E,value:A})}return D},publishAvailableFields:function e(){var A={};A.options=this.getAvailableFields();this.alfLog("log","Publishing available fields:",A,this);this.alfPublish(this.childPubSubScope+"ALF_FORM_FIELDS_UPDATE",A,true)},deleteItem:function s(A){this.alfLog("log","Delete widget request detected",A);if(A.target!=null&&A.target.id!=null&&this.previewTarget.getItem(A.target.id)!=null&&A.widgetToDelete!=null){var C=this.previewTarget.getItem(A.target.id);var B=z.getObject("data.defaultConfig.fieldId",false,C),D=z.getObject("data.parentId",false,C);if(B!=null&&D!=null){this.removeReferencesFromParent(D,B);this.alfSetData(B,null)}A.widgetToDelete.destroyRecursive(false);this.previewTarget.delItem(A.target.id);if(this.previewTarget.getAllNodes().length===0){j.remove(this.previewNode,"containsItems")}this.alfPublish("ALF_CLEAR_CONFIGURE_WIDGET",{});this.refreshChildren();this.publishAvailableFields()}},updateItem:function c(G){if(G.node!=null){var D=g.some(this.previewTarget.getAllNodes(),function(K,J){return G.node.id==K.id});if(D===true){this.alfLog("log","Updating item",G);var E=G.originalConfig.defaultConfig.fieldId;var A=this.alfGetData(E);if(A!=null){var C=(A.itemNameKey!=null)?A.itemNameKey:"name",B=(A.itemConfigKey!=null)?A.itemConfigKey:"config";A.widgetConfig={};A.widgetConfig[C]=A.module;A.widgetConfig[B]={};A.updatedConfig={defaultConfig:{},additionalConfig:{}};var I;for(var H in G.updatedConfig.defaultConfig){I=G.updatedConfig.defaultConfig[H];A.widgetConfig[B][H]=I;z.setObject(H,I,A.updatedConfig.defaultConfig)}for(H in G.updatedConfig.additionalConfig){I=G.updatedConfig.additionalConfig[H];A.widgetConfig[H]=I;z.setObject(H,I,A.updatedConfig.additionalConfig)}g.forEach(A.widgetsForConfig,z.hitch(this,this.updateWidgetConfig,G.updatedConfig))}g.forEach(this.previewTarget.getSelectedNodes(),function(K,J){var L=h.byNode(K);if(L){L.destroyRecursive(true)}},this);try{this.previewTarget.insertNodes(false,[A],true,G.node)}catch(F){this.alfLog("log","Error",F)}finally{this.alfLog("log","Finally")}this.previewTarget.deleteSelectedNodes();this.refreshChildren();this.publishAvailableFields()}}},removeReferencesFromParent:function m(C,A){if(C!=null){var B=this.alfGetData(C);if(B!=null){B.children=g.filter(B.children,function(E,D){return E!=A},this)}else{this.alfLog("warn","Expected to find parentId in the data model",C,this)}}},creator:function t(O,G){this.alfLog("log","Creating",O,G);var C=f.create("div");if(O.module!=null&&O.module!==""){var J=z.clone(O);var B=(J.defaultConfig!=null)?J.defaultConfig:{};if(B.fieldId===undefined){B.fieldId=this.generateUuid()}var L=null;var A=this.alfGetData(B.fieldId);if(A!=null){L=A.widgetsForDisplay}else{var I=(J.itemNameKey!=null)?J.itemNameKey:"name",F=(J.itemConfigKey!=null)?J.itemConfigKey:"config";J.widgetConfig={};J.widgetConfig[I]=J.module;J.widgetConfig[F]={};for(var N in J.defaultConfig){var M=J.defaultConfig[N];J.widgetConfig[F][N]=M}if(J.previewWidget===true||J.widgetsForDisplay==null||J.widgetsForDisplay.length===0){L=[{name:J.module,config:B}]}else{L=J.widgetsForDisplay}}if(this.widgetsForNestedConfig!=null){if(J.originalConfigWidgets===undefined){J.originalConfigWidgets=z.clone(J.widgetsForConfig)}var K=z.clone(this.widgetsForNestedConfig);if(A!=null&&A.updatedConfig!=null){g.forEach(J.originalConfigWidgets,function(Q,P){if(Q.config.name){this.updateWidgetConfig(A.updatedConfig,Q,0)}},this);g.forEach(K,z.hitch(this,this.updateWidgetConfig,A.updatedConfig.additionalConfig))}else{J.widgetsForConfig=J.originalConfigWidgets.concat(K);g.forEach(J.widgetsForConfig,z.hitch(this,this.updateWidgetConfig,J))}}g.forEach(J.widgetsForConfig,function(Q,P){z.setObject("config.pubSubScope",this.childPubSubScope,Q)},this);var D=this.getMyUuid();this.removeReferencesFromParent(J.parentId,B.fieldId);J.parentId=D;var H=this.alfGetData(D);if(H==null){this.alfLog("warn","No entry in the data model for DropZone!",this)}else{if(H.children==null){H.children=[]}H.children.push(B.fieldId)}this.alfSetData(B.fieldId,J);var E=new d({fieldId:B.fieldId,parentPubSubScope:this.childPubSubScope,pubSubScope:this.pubSubScope,widgets:L,moduleName:J.name},C)}else{this.alfLog("log","The requested item to create was missing a 'module' attribute",O,this)}j.add(this.previewNode,"containsItems");return{node:E.domNode,data:J,type:["widget"]}},updateWidgetConfig:function p(D,C,B){if(C.config.name){var A=z.getObject(C.config.name,false,D);if(A!=null){C.config.value=A}}else{if(C.config.widgets){g.forEach(C.config.widgets,z.hitch(this,this.updateWidgetConfig,D))}}},getMyUuid:function x(){var A=z.getObject("_dropZoneWrapperId",false,this);if(A==null){A=this.id}return A},onWidgetSelected:function a(C){var D=this.previewTarget.getSelectedNodes();if(D.length>0&&D[0]!=null){var A=this.previewTarget.getItem(D[0].id);this.alfLog("log","Widget selected",A);var B={pubSubScope:this.childPubSubScope,selectedNode:D[0],selectedItem:A.data};this.alfPublish("ALF_CONFIGURE_WIDGET",B)}},refreshChildren:function k(){this.alfLog("log","Widgets updated");var F=this.getMyUuid();var E=this.alfGetData(F);var C={};var B=this.previewTarget.getAllNodes();g.forEach(B,function(I,G){var H=this.previewTarget.getItem(I.id);var J=z.getObject("data.updatedConfig.defaultConfig.fieldId",false,H);if(J==null){J=z.getObject("data.defaultConfig.fieldId",false,H)}C[J]=G},this);var A=[];var D=[];g.forEach(E.children,function(J,I){var G=this.alfGetData(J);var K=z.getObject("updatedConfig.defaultConfig.fieldId",false,G);if(K==null){K=z.getObject("defaultConfig.fieldId",false,G)}var H=C[K];A[H]=G;D[H]=J},this);E.children=D;E.widgetsForDisplay=[{name:"alfresco/creation/DropZone",config:{attributeKey:(this.attributeKey!=null)?this.attributeKey:"widgets",horizontal:this.horizontal,widgetsForNestedConfig:this.widgetsForNestedConfig,initialItems:A}}];l.emit(this.domNode,"onWidgetUpdate",{bubbles:true,cancelable:true})}})});