define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/WidgetConfig.html","alfresco/core/Core","alfresco/forms/Form","dojo/_base/lang","dijit/registry","dojo/_base/array","dijit/form/Button","dojo/dom-class"],function(j,e,p,q,d,l,c,a,m,k,n){return j([e,p,d],{cssRequirements:[{cssFile:"./css/WidgetConfig.css"}],i18nRequirements:[{i18nFile:"./i18n/WidgetConfig.properties"}],templateString:q,configTopic:"ALF_CONFIGURE_WIDGET",clearTopic:"ALF_CLEAR_CONFIGURE_WIDGET",saveTopic:"ALF_SAVE_CONFIGURE_WIDGET",postCreate:function f(){this.alfSubscribe(this.configTopic,c.hitch(this,"displayWidgetConfig"))},currentWidgetConfig:null,saveWidgetConfig:function g(){if(this.currentWidgetConfig!=null){var r={};if(this.form==null){this.alfLog("warn","No form instance found to retrieve config data from",this)}else{r=this.form.getValue()}this.alfPublish("ALF_UPDATE_RENDERED_WIDGET",{node:this.currentWidgetConfig.selectedNode,updatedConfig:r,originalConfig:this.currentWidgetConfig.selectedItem});this.clearCurrentDisplay()}},clearCurrentDisplay:function b(){var r=a.findWidgets(this.configNode);m.forEach(r,c.hitch(this,"destroyOldConfigWidget"))},displayWidgetConfig:function o(s){this.clearCurrentDisplay();this.alfUnsubscribe(this._saveSubscriptionHandle);this.alfUnsubscribe(this._clearSubscriptionHandle);if(c.exists("selectedItem.widgetsForConfig",s)){this.currentWidgetConfig=s;var r=c.getObject("currentWidgetConfig.pubSubScope",false,this);if(r==null){r=""}this._saveSubscriptionHandle=this.alfSubscribe(r+this.clearTopic,c.hitch(this,"clearCurrentDisplay"),true);this._clearSubscriptionHandle=this.alfSubscribe(r+this.saveTopic,c.hitch(this,"saveWidgetConfig"),true);this.form=new l({pubSubScope:r,okButtonPublishTopic:this.saveTopic,okButtonLabel:this.message("saveConfig.button.label"),cancelButtonPublishTopic:this.clearTopic,widgets:s.selectedItem.widgetsForConfig});this.form.placeAt(this.configNode)}},allWidgetsProcessed:function i(r){this.alfLog("log","Widget config processed")},destroyOldConfigWidget:function h(s,r){s.destroyRecursive(false)}})});