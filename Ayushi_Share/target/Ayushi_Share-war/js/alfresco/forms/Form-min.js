define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/Form","alfresco/core/Core","alfresco/core/CoreWidgetProcessing","alfresco/documentlibrary/_AlfHashMixin","dojo/text!./templates/Form.html","dojo/io-query","dojo/hash","dojo/_base/lang","alfresco/buttons/AlfButton","dojo/_base/array","dijit/registry"],function(w,p,k,g,q,t,o,z,v,a,B,r,h,i){return w([p,k,q,t,o],{i18nRequirements:[{i18nFile:"./i18n/Form.properties"}],templateString:z,_form:null,widgets:null,postUrl:"",convertFormToJsonString:false,invalidFormControls:null,okButton:null,cancelButton:null,scopeFormControls:true,displayButtons:true,postCreate:function s(){this.invalidFormControls=[];if(this.scopeFormControls===true&&this.pubSubScope===""){this.pubSubScope=this.generateUuid()}this._form=new g({id:this.generateUuid()},this.formNode);this.alfSubscribe("ALF_INVALID_CONTROL",B.hitch(this,"onInvalidField"));this.alfSubscribe("ALF_VALID_CONTROL",B.hitch(this,"onValidField"));if(this.displayButtons===true){this.createButtons()}if(this.widgets){this.processWidgets(this.widgets,this._form.domNode)}},onInvalidField:function n(D){var C=h.some(this.invalidFormControls,function(E){return E==D.fieldId});if(!C){this.invalidFormControls.push(D.fieldId)}if(this.okButton){this.okButton.set("disabled","true")}this.publishFormValidity()},publishFormValidity:function l(){this.alfPublish("ALF_FORM_VALIDITY",{valid:(this.invalidFormControls.length===0),invalidFormControls:this.invalidFormControls})},onValidField:function A(D){this.invalidFormControls=h.filter(this.invalidFormControls,function(E){return E!=D.fieldId});if(this.okButton){this.okButton.set("disabled",this.invalidFormControls.length>0)}this.publishFormValidity();var C=this.getValue();h.forEach(this.additionalButtons,function(F,E){if(F.publishPayload!=null){B.mixin(F.publishPayload,C)}else{F.publishPayload=C}});if(this.widgetProcessingComplete){this.publishValidValue()}},validFormValuesPublishTopic:null,validFormValuesPublishPayload:null,validFormValuesPublishGlobal:false,validFormValuesPublishOnInit:false,showOkButton:true,showCancelButton:true,okButtonLabel:"form.button.ok.label",okButtonPublishTopic:null,okButtonPublishPayload:null,okButtonPublishGlobal:null,cancelButtonLabel:"form.button.cancel.label",cancelButtonPublishTopic:null,cancelButtonPublishPayload:null,cancelButtonPublishGlobal:null,widgetsAdditionalButtons:null,additionalButtons:null,useHash:false,setHash:false,setHashFragment:function e(D){delete D.alfTopic;var C=v.objectToQuery(D);this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:C,type:"HASH"},true)},onHashChange:function d(D){if(this.useHash===true){var C=this.processFilter(D);this.setValue(C)}},createButtons:function u(){if(this.showOkButton===true){this.okButton=new r({pubSubScope:this.pubSubScope,label:this.message(this.okButtonLabel),additionalCssClasses:"confirmationButton "+((this.okButtonClass!=null)?this.okButtonClass:""),publishTopic:this.okButtonPublishTopic,publishPayload:this.okButtonPublishPayload,publishGlobal:this.okButtonPublishGlobal,iconClass:this.okButtonIconClass},this.okButtonNode);if(this.setHash===true){if(this.okButtonPublishTopic!=null&&B.trim(this.okButtonPublishTopic)!=null){this.alfSubscribe(this.okButtonPublishTopic,B.hitch(this,"setHashFragment"),this.okButtonPublishGlobal)}else{this.alfLog("warn","A form is configured to use the browser hash fragment, but has no okButtonPublishTopic set",this)}}}if(this.showCancelButton===true){this.cancelButton=new r({pubSubScope:this.pubSubScope,label:this.message(this.cancelButtonLabel),additionalCssClasses:"cancelButton",publishTopic:this.cancelButtonPublishTopic,publishPayload:this.cancelButtonPublishPayload,publishGlobal:this.cancelButtonPublishGlobal,iconClass:this.cancelButtonIconClass},this.cancelButtonNode)}if(this.widgetsAdditionalButtons!=null){this.additionalButtons=[];this.__creatingButtons=true;this.processWidgets(this.widgetsAdditionalButtons,this.buttonsNode)}else{this.additionalButtons=i.findWidgets(this.buttonsNode)}},allWidgetsProcessed:function f(D){if(this.__creatingButtons===true){this.additionalButtons=i.findWidgets(this.buttonsNode);this.__creatingButtons=false}else{if(this.useHash){var C=v.queryToObject(a());this.setValue(C)}else{this.setValue(this.value)}h.forEach(D,function(F,E){if(F.publishValue&&typeof F.publishValue=="function"){F.publishValue()}})}this.validate();if(this.validFormValuesPublishOnInit){this.publishValidValue()}},updateButtonPayloads:function c(C){h.forEach(this.additionalButtons,function(E,D){if(E.payload==null){E.payload={}}B.mixin(E.payload,C)})},focus:function b(){if(this._form){var C=this._form.getChildren();if(C.length>0&&C[0].wrappedWidget&&typeof C[0].wrappedWidget.focus==="function"){C[0].wrappedWidget.focus()}}},getValue:function y(){var C={};if(this._form){h.forEach(this._form.getChildren(),function(E,D){if(typeof E.addFormControlValue==="function"){E.addFormControlValue(C)}})}this.alfLog("log","Returning form values: ",C);this.updateButtonPayloads(C);return C},setValue:function m(C){this.alfLog("log","Setting form values: ",C);if(C&&C instanceof Object){if(this._form){h.forEach(this._form.getChildren(),function(E,D){if(typeof E.updateFormControlValue==="function"){E.updateFormControlValue(C)}if(typeof E.publishValue=="function"){E.publishValue()}})}}this.validate();this.updateButtonPayloads(C)},validate:function x(){this.alfLog("log","Validating form",this._form);h.forEach(this._processedWidgets,function(D,C){if(typeof D.validateFormControlValue==="function"){D.validateFormControlValue()}});return this.invalidFormControls.length===0},publishValidValue:function j(){if(this.invalidFormControls.length===0&&this.validFormValuesPublishTopic){var C=this.validFormValuesPublishPayload;if(!C){C=this.getValue()}this.alfPublish(this.validFormValuesPublishTopic,C,this.validFormValuesPublishGlobal)}}})});