define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_FocusMixin","alfresco/core/Core","alfresco/forms/controls/FormControlValidationMixin","dojo/text!./templates/BaseFormControl.html","alfresco/core/ObjectTypeUtils","alfresco/core/ArrayUtils","dojo/_base/lang","dojo/_base/array","dojo/dom-style","dojo/dom-class","dijit/Tooltip","dojo/dom-attr","dojo/query","dojo/dom-construct"],function(h,x,v,B,y,w,k,r,f,j,l,ad,z,K,X,ab,W){return h([x,v,B,y,w],{cssRequirements:[{cssFile:"./css/BaseFormControl.css"}],i18nRequirements:[{i18nFile:"./i18n/BaseFormControl.properties"}],templateString:k,wrappedWidget:null,pubSubScope:"",type:"",fieldId:"",label:"",unitsLabel:"",description:"",name:"",value:"",options:null,postWhenHiddenOrDisabled:true,noValueUpdateWhenHiddenOrDisabled:false,noPostWhenValueIs:null,_visible:true,alfVisible:function P(ai){this.alfLog("log","Change visibility status for '"+this.fieldId+"' to: "+ai);this._visible=ai;if(this.containerNode){var aj=ai?"":"none";ad.set(this.containerNode,{display:aj})}},_required:false,alfRequired:function s(ai){this.alfLog("log","Change requirement status for '"+this.fieldId+"' to: "+ai,{});this._required=ai;if(this._requirementIndicator){if(this._required===true){z.add(this._requirementIndicator,"required")}else{z.remove(this._requirementIndicator,"required")}this.validate()}},_disabled:false,alfDisabled:function F(ai){this.alfLog("log","Change disablement status for '"+this.fieldId+"' to: "+ai);this._disabled=ai;if(this.wrappedWidget&&typeof this.wrappedWidget.set==="function"){this.wrappedWidget.set("disabled",ai)}},visibilityConfig:null,requirementConfig:null,disablementConfig:null,autoSetConfig:null,constructor:function o(ai){h.safeMixin(this,ai);if(this.fieldId==null||this.fieldId===""){this.fieldId=this.generateUuid()}this.processConfig("alfVisible",this.visibilityConfig);this.processConfig("alfRequired",this.requirementConfig);this.processConfig("alfDisabled",this.disablementConfig);l.forEach(this.autoSetConfig,j.hitch(this,this.processAutoSetConfiguration));this.processOptionsConfig(this.optionsConfig);if(this.validationConfig!=null&&typeof this.validationConfig.regex=="string"){this.validationConfig.regExObj=new RegExp(this.validationConfig.regex)}},processAutoSetConfiguration:function H(aj,ai){if(aj.rulePassValue==null||aj.ruleFailValue==null){this.alfLog("warn","An autoset configuration element was provided without both 'rulePassValue' and 'ruleFailValue' attribute",aj,this)}else{var ak="alfAutoSet___"+ai;this[ak]=j.hitch(this,this.autoSetValue,aj.rulePassValue,aj.ruleFailValue);this.processConfig(ak,aj)}},autoSetValue:function Z(aj,ak,ai){if(ai===true){this.setValue(aj)}else{this.setValue(ak)}},processOptionsConfig:function I(ak){if(ak!=null){var aj=j.getObject("changesTo",false,ak);if(aj!=null){if(r.isArray(aj)){l.forEach(ak.changesTo,j.hitch(this,"createOptionsChangesTo",ak))}else{this.alfLog("warn","The supplied 'changesTo' attribute for '"+this.fieldId+"' was not an Array")}}var am=j.getObject("updateTopics",false,ak);if(am!=null){if(r.isArray(am)){l.forEach(ak.updateTopics,j.hitch(this,"createOptionsSubscriptions",ak))}else{this.alfLog("warn","The supplied 'updateTopics' attribute for '"+this.fieldId+"' was not an Array")}}var ai=j.getObject("publishTopic",false,ak),an=j.getObject("callback",false,ak),al=j.getObject("fixed",false,ak);if(ai!=null){this.getPubSubOptions(ak)}else{if(an!=null){if(typeof an==="function"){this.options=an(ak);l.forEach(this.options,j.hitch(this,this.processOptionLabel))}else{if(r.isString(an)&&typeof this[an]==="function"){this.options=this[an](ak);l.forEach(this.options,j.hitch(this,this.processOptionLabel))}else{this.alfLog("warn","The supplied 'callback' attribute for '"+this.fieldId+"' was not a Function")}}}else{if(al!=null){if(r.isArray(al)){this.options=al;l.forEach(this.options,j.hitch(this,this.processOptionLabel));this.setOptionsValue(this.options)}else{this.alfLog("log","The supplied fixed options attribute for '"+this.fieldId+"' was not an Array")}}}}}},processOptionLabel:function ag(al,aj){var ak=this.optionsConfig.labelAttribute?this.optionsConfig.labelAttribute:"label";var ai=this.optionsConfig.valueAttribute?this.optionsConfig.valueAttribute:"value";if(al[ak]){al.label=this.message(al[ak])}else{if(al[ai]){al.label=al[ai]}else{this.alfLog("warn","An option was provided with neither label nor value",al,this)}}},createOptionsChangesTo:function M(am,al,aj){if(al.targetId==null){this.alfLog("warn","No 'targetId' defined in subscription config",al,am,this)}else{var ai="_valueChangeOf_"+al.targetId,ak=(al.global!=null?al.global:false);this.alfSubscribe(ai,j.hitch(this,"updateOptions",am),ak)}},createOptionsSubscriptions:function aa(al,ak,ai){if(ak.topic==null){this.alfLog("warn","No 'topic' defined in subscription config",ak,al,this)}else{var aj=(ak.global!=null?ak.global:false);this.alfSubscribe(ak.topic,j.hitch(this,"updateOptions",al),aj)}},getOptionsFromPublication:function C(ak,aj){var ai=j.getObject("options",false,aj);if(ai!=null&&r.isArray(ai)){return ai}else{return[]}},updateOptions:function E(aj,ai){this.alfLog("log","OPTIONS CONFIG: Field '"+this.fieldId+"' is handling value change of field'"+ai.name);if(aj.publishTopic!=null){this.getPubSubOptions(aj)}else{if(aj.callback!=null){if(typeof aj.callback=="function"){this.setOptions(aj.callback(aj,ai,this))}else{if(typeof aj.callback=="string"&&typeof this[aj.callback]=="function"){this.setOptions(this[aj.callback](aj,ai,this))}else{this.alfLog("log","The supplied 'callback' attribute for '"+this.fieldId+"' was neither a String nor a function")}}}}},_pubSubOptionsHandle:null,getPubSubOptions:function ah(aj){if(aj.publishTopic!=null){var ai=this.generateUuid();var ak=aj.publishPayload;if(ak==null){ak={}}ak.responseTopic=ai;this._pubSubOptionsHandle=this.alfSubscribe(ai,j.hitch(this,"onPubSubOptions"),true);this.alfPublish(aj.publishTopic,ak,true)}else{this.alfLog("warn","A request was made to obtain form control options via PubSub, but no 'publishTopic' attribute was provided",aj,this)}},onPubSubOptions:function g(ai){this.alfUnsubscribeSaveHandles([this._pubSubOptionsHandle]);if(ai.options!=null){this.setOptions(ai.options)}else{this.alfLog("warn","No 'options' attribute published in payload for pubSub options",ai,this)}},setOptions:function G(aj){this.alfLog("log","Setting options for field '"+this.fieldId+"'",aj);this.options=aj;if(this.wrappedWidget){var ai=this.wrappedWidget.get("options");if(ai&&typeof this.wrappedWidget.removeOption==="function"){l.forEach(ai,j.hitch(this,this.removeOption))}if(typeof this.wrappedWidget.addOption==="function"){l.forEach(aj,j.hitch(this,this.addOption))}}this.setOptionsValue(aj)},setOptionsValue:function A(ai){var aj=this.getValue();var ak=l.some(ai,function(am,al){return am.value==aj});if(ak){this.setValue(aj);this.value=aj}else{if(ai.length>0){this.setValue(ai[0].value);this.value=ai[0].value}}},removeOption:function n(aj,ai){this.wrappedWidget.removeOption(aj)},addOption:function ae(aj,ai){this.processOptionLabel(aj,ai);this.wrappedWidget.addOption(aj)},processConfig:function i(aj,ai){if(ai){if(typeof ai.initialValue!="undefined"){this[aj](ai.initialValue)}if(typeof ai.rules!="undefined"){this.processRulesConfig(aj,ai.rules)}else{if(typeof ai.rules!="undefined"){this.alfLog("log","The rules configuration for attribute '"+aj+"' for property '"+this.fieldId+"' was not an Object")}}if(typeof ai.callbacks=="object"){this._processCallbacksConfig(aj,ai.callbacks)}else{if(typeof ai.callbacks!="undefined"){this.alfLog("log","The callback configuration for attribute '"+aj+"' for property '"+this.fieldId+"' was not an Object")}}}},_rulesEngineData:null,processRulesConfig:function D(ai,aj){if(this._rulesEngineData==null){this._rulesEngineData={}}if(typeof this._rulesEngineData[ai]=="undefined"){this._rulesEngineData[ai]={}}l.forEach(aj,j.hitch(this,"processRule",ai))},processRule:function U(aj,ak,ai){if(ak.targetId!=null){if(typeof this._rulesEngineData[aj][ak.targetId]=="undefined"){this._rulesEngineData[aj][ak.targetId]={}}this._rulesEngineData[aj][ak.targetId].rules=ak;this.alfSubscribe("_valueChangeOf_"+ak.targetId,j.hitch(this,"evaluateRules",aj))}else{this.alfLog("warn","The following rule is missing a 'name' attribute",ak,this)}},evaluateRules:function L(ai,am){this.alfLog("log","RULES EVALUATION('"+ai+"'): Field '"+this.fieldId+"'");this._rulesEngineData[ai][am.fieldId].currentValue=am.value;var ak=true;var an=false;for(var aq in this._rulesEngineData[ai]){an=true;if(ak){var ap=this._rulesEngineData[ai][aq].currentValue;var aj=this._rulesEngineData[ai][aq].rules.is;var ar=this._rulesEngineData[ai][aq].rules.isNot;var ao=(typeof aj=="undefined"||aj.length===0);var al=(typeof ar!="undefined"&&ar.length>0);if(al){al=l.some(ar,j.hitch(this,"ruleValueComparator",ap))}if(!al&&typeof aj!="undefined"&&aj.length>0){ao=l.some(aj,j.hitch(this,"ruleValueComparator",ap))}ak=ak&&ao&&!al}}ak=ak&&an;this[ai](ak);return ak},ruleValueComparator:function u(ai,aj){this.alfLog("log","Comparing",ai,aj);if(ai!=null&&aj.value!=null){return ai.toString()==aj.value.toString()}else{return ai==aj}},_processCallbacksConfig:function Y(ak,aj){var al=this;for(var ai in aj){if(typeof aj[ai]=="function"){al.alfSubscribe("_valueChangeOf_"+ai,function(an){var am=aj[an.name](an.name,an.oldValue,an.value,al,ak);al[ak](am)})}else{if(typeof aj[ai]=="string"&&typeof al[aj[ai]]=="function"){al.alfSubscribe(al.pubSubScope+"_valueChangeOf_"+ai,function(an){var am=al[aj[an.name]](an.name,an.oldValue,an.value,al,ak);al[ak](am)})}else{this.alfLog("log","The callback for property '"+al.name+"' for handling changes to property '"+ai+"' was not a function or was not a String that references a local function")}}}},validationInProgressImg:"ajax_anim.gif",validationInProgressAltText:"validation.inprogress.alttext",postMixInProperties:function R(){if(this.validationInProgressImgSrc==null||this.validationInProgressImgSrc===""){this.validationInProgressImgSrc=require.toUrl("alfresco/forms/controls")+"/css/images/"+this.validationInProgressImg}this.validationInProgressAltText=this.message(this.validationInProgressAltText)},postCreate:function S(){this.initialConfig=this.getWidgetConfig();if(typeof this.initialConfig.disabled=="undefined"){this.initialConfig.disabled=this._disabled}if(this.additionalCssClasses!=null){z.add(this.domNode,this.additionalCssClasses)}this.wrappedWidget=this.createFormControl(this.initialConfig);if(this.isPromisedWidget&&typeof this.wrappedWidget.then==="function"){this.wrappedWidget.then(j.hitch(this,"onPromisedWidget"))}else{this.completeWidgetSetup()}},isPromisedWidget:false,onPromisedWidget:function q(ai){this.wrappedWidget=ai;this.completeWidgetSetup()},placeWidget:function p(){if(this.wrappedWidget!=null&&typeof this.wrappedWidget.placeAt==="function"){this.wrappedWidget.placeAt(this._controlNode)}else{this.alfLog("warn","The wrapped widget has no 'placeAt' function - perhaps the 'placeWidget' function should be overridden?",this)}},completeWidgetSetup:function ac(){this.placeWidget();this.setupChangeEvents();this.alfVisible(this._visible);this.alfRequired(this._required);this.alfDisabled(this._disabled);var aj=j.getObject("id",false,this.wrappedWidget);if(this.label!=null&&j.trim(this.label)!==""){this._labelNode.innerHTML=this.encodeHTML(this.message(this.label));if(aj!=null){X.set(this._labelNode,"for",this.wrappedWidget.id)}}else{ad.set(this._titleRowNode,{display:"none"})}if(this.description!=null&&j.trim(this.description)!==""){this._descriptionNode.innerHTML=this.encodeHTML(this.message(this.description))}else{ad.set(this._descriptionRowNode,{display:"none"})}if(this.unitsLabel!=null&&this.unitsLabel!==""){this._unitsNode.innerHTML=this.encodeHTML(this.message(this.unitsLabel))}else{ad.set(this._unitsNode,{display:"none"})}if(this.validationConfig!=null&&typeof this.validationConfig.errorMessage=="string"){this._validationMessage.innerHTML=this.encodeHTML(this.message(this.validationConfig.errorMessage))}var ak=ab("input.dijitValidationIcon.dijitValidationInner",this._controlNode);if(ak&&ak.length>0&&aj!=null){var ai=this.wrappedWidget.id+"_validationInput";X.set(ak[0],"id",ai);W.create("label",{innerHTML:this.message("validation.control.invalid"),"for":ai,"class":"hiddenAccessible"},ak[0],"before")}},setupChangeEvents:function ac(){if(this.wrappedWidget){this.wrappedWidget.watch("value",j.hitch(this,"onValueChangeEvent"))}},onValueChangeEvent:function b(aj,ai,ak){this.formControlValueChange(aj,ai,ak);this.validate()},getValue:function m(){var ai=null;if(this.wrappedWidget){try{ai=this.wrappedWidget.getValue()}catch(aj){this.alfLog("log","An exception was thrown retrieving the value for field: '"+this.fieldId+"'")}}if(this._convertStringValuesToBooleans===true&&r.isString(ai)){if(ai.toLowerCase()==="true"){ai=true}else{if(ai.toLowerCase()==="false"){ai=false}}}return ai},setValue:function e(ai){this.alfLog("log","Setting field: '"+this.fieldId+"' with value: ",ai);if(this.wrappedWidget){if(this._convertStringValuesToBooleans===true&&typeof ai==="boolean"){ai=ai.toString()}this.wrappedWidget.setValue(ai)}},publishValue:function J(){this.alfLog("log","Publishing value for field: '"+this.fieldId+"'");if(this.wrappedWidget){this.alfPublish("_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,oldValue:this.getValue(),value:this.getValue()})}},formControlValueChange:function d(aj,ai,ak){this.alfPublish("_valueChangeOf_"+this.fieldId,{fieldId:this.fieldId,name:this.name,oldValue:ai,value:ak})},createFormControl:function O(ai){},getWidgetConfig:function Q(){return{}},startup:function a(){},validationConfig:null,validate:function V(){if(this.validationConfig!=null&&r.isArray(this.validationConfig)){this.startValidation()}else{var ai=this.processValidationRules();if(ai){this.alfPublish("ALF_VALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.hideValidationFailure()}else{this.alfPublish("ALF_INVALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.showValidationFailure()}}},processValidationRules:function c(){var ai=true;if(this._visible&&!this._disabled){var ak=this.getValue();this.alfLog("log","Validating: '"+this.fieldId+"' with value:",ak);var aj=true,al=true;aj=!(this._required&&(ak==null||ak===""));if(this.validationConfig!=null){if(typeof this.validationConfig.regExObj!="undefined"&&this.validationConfig.regExObj instanceof RegExp){al=this.validationConfig.regExObj.test(ak)}}ai=aj&&al}else{}return ai},showValidationFailure:function af(){z.add(this._validationIndicator,"validation-error");z.add(this._validationMessage,"display")},hideValidationFailure:function N(){z.remove(this._validationIndicator,"validation-error");z.remove(this._validationMessage,"display")},addFormControlValue:function t(ai){if(((this._visible!==undefined&&this._visible===false)||(this._disabled!==undefined&&this._disabled===true))&&(this.postWhenHiddenOrDisabled!==undefined&&this.postWhenHiddenOrDisabled===false)){}else{if(this.noPostWhenValueIs&&f.arrayContains(this.noPostWhenValueIs,this.getValue())){}else{j.setObject(this.get("name"),this.getValue(),ai)}}},updateFormControlValue:function t(aj){if(((this._visible!==undefined&&this._visible===false)||(this._disabled!==undefined&&this._disabled===true))&&(this.noValueUpdateWhenHiddenOrDisabled!==undefined&&this.noValueUpdateWhenHiddenOrDisabled===true)){}else{var ai=j.getObject(this.get("name"),false,aj);if(ai!==undefined){this.setValue(ai)}}},validateFormControlValue:function T(){if(this.publishValue&&typeof this.publishValue=="function"){this.validate()}}})});