define(["dojo/_base/declare","dojo/store/JsonRest","alfresco/core/Core","dojo/Deferred","dojo/_base/lang","dojo/_base/array","dojo/store/util/QueryResults","dojo/store/util/SimpleQueryEngine"],function(h,e,d,n,c,k,g,l){return h([e,d],{publishTopic:null,publishPayload:null,queryAttribute:"name",fixed:null,get:function o(v,s){var q=null;if(this.publishTopic!=null){q=new n();var r=this.generateUuid();var u=c.clone(this.publishPayload);if(u==null){u={}}u.alfResponseTopic=r;var t=(this.publishPayload.resultsProperty!=null)?this.publishPayload.resultsProperty:"response";this._getOptionsHandle=[];this._getOptionsHandle.push(this.alfSubscribe(r+"_SUCCESS",c.hitch(this,"onGetOptions",q,t,v),true));this.alfPublish(this.publishTopic,u,true)}else{if(this.fixed!=null){q=this.getOption(c.clone(this.fixed),v)}else{this.alfLog("warn","A ServiceStore was set up without 'publishTopic' or 'fixed' attributes to use to retrieve options",this);q=""}}return q},onGetOptions:function i(q,s,v,u){this.alfUnsubscribeSaveHandles([this._getOptionsHandle]);var r=c.getObject(s,false,u);if(r!=null){var t=this.getOption(r,v);q.resolve(t)}else{this.alfLog("warn","No '"+s+"' attribute published in payload for the query options",u,this);q.resolve("")}},getOption:function p(q,s){var r="";k.forEach(q,function(u,t){if(u[this.valueAttribute]==s){r=u}},this);return r},queryResults:function a(w,x){var v=(this.queryAttribute!=null)?this.queryAttribute:"name";var u=(this.labelAttribute!=null)?this.labelAttribute:"label";var r=(this.valueAttribute!=null)?this.valueAttribute:"value";k.forEach(w,c.hitch(this,this.processResult,v,u,r));var t={};t[this.queryAttribute]=new RegExp("^"+x[this.queryAttribute].toString()+".*$","i");var q=l(t);var s=g(q(w));return s},processResult:function j(t,s,q,u,r){if(u[t]==null){u[t]=""}if(u.label==null&&u[s]!=null){u.label=u[s]}if(u.value==null&&u[q]!=null){u.value=u[q]}},queryFixedOptions:function b(s,r){var q=this.queryResults(c.clone(this.fixed),s);return q},queryXhrOptions:function f(u,s){var q=new n();var r=this.generateUuid();var v=c.clone(this.publishPayload);if(v==null){v={}}v.alfResponseTopic=r;var t=(this.publishPayload.resultsProperty!=null)?this.publishPayload.resultsProperty:"response";v.query=u[(this.queryAttribute!=null)?this.queryAttribute:"name"];this._optionsHandle=[];this._optionsHandle.push(this.alfSubscribe(r+"_SUCCESS",c.hitch(this,"onQueryOptions",q,u,t),true));this._optionsHandle.push(this.alfSubscribe(r,c.hitch(this,"onQueryOptions",q,u,t),true));this.alfPublish(this.publishTopic,v,true);return q},query:function f(s,r){var q=null;if(this.publishTopic!=null){q=this.queryXhrOptions(s,r)}else{if(this.fixed!=null){q=this.queryFixedOptions(s,r)}else{this.alfLog("warn","A ServiceStore was set up without 'publishTopic' or 'fixed' attributes to use to retrieve options",this);q={}}}return q},onQueryOptions:function m(q,u,t,v){this.alfUnsubscribeSaveHandles([this._optionsHandle]);var s=c.getObject(t,false,v);if(s!=null){var r=this.queryResults(s,u);q.resolve(r)}else{this.alfLog("warn","No '"+t+"' attribute published in payload for the query options",v,this);q.resolve([])}}})});