define(["dojo/_base/declare","alfresco/core/Core","dojo/_base/lang","dojo/_base/array","dojo/dom-class"],function(h,d,c,l,m){return h([d],{_validationInProgress:false,_validatorsInProgress:null,_validationInProgressState:true,_validationErrorMessage:null,startValidation:function e(){if(this._validationInProgress===true){this._queuedValidationRequest=true}else{this._validationInProgressState=true;this._validatorsInProgress={};this._validationErrorMessage="";this._validationMessage.innerHTML=this._validationErrorMessage;this._validationInProgress=true;this._queuedValidationRequest=false;this.alfPublish("ALF_INVALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.hideValidationFailure();m.remove(this._validationInProgressIndicator,"hidden");var p=[];passedValidationArray=l.forEach(this.validationConfig,c.hitch(this,this.processValidationArrayElement,p));var s=this.countValidatorsInProgress();if(s===0){this.validationComplete()}else{for(var q in this._validatorsInProgress){var r=this._validatorsInProgress[q];this[r.validation](r)}}}},processValidationArrayElement:function a(q,s,r){var p=c.getObject("validation",false,s);if(p!=null){if(typeof this[p]==="function"){this._validatorsInProgress[r]=s;s.index=r}else{this.alfLog("warn","Validation configuration 'validation' attribute refers to non-existent function",p,this)}}else{this.alfLog("warn","Validation configuration missing a 'validation' attribute",s,this)}},countValidatorsInProgress:function k(){var q=0;for(var p in this._validatorsInProgress){if(this._validatorsInProgress.hasOwnProperty(p)){q++}}return q},reportValidationResult:function n(r,p){this.alfLog("log","Validator complete, result: "+p,r);var q=c.getObject("index",false,r);if(q==null){this.alfLog("warn","Validation completion call without index attribute",r,this)}else{if(p===false){if(r.errorMessage!=null){if(this._validationErrorMessage.length!==0){this._validationErrorMessage+=", "}this._validationErrorMessage+=this.message(r.errorMessage)}this.showValidationFailure();this._validationMessage.innerHTML=this._validationErrorMessage}this._validationInProgressState=this._validationInProgressState&&p;delete this._validatorsInProgress[q];var s=this.countValidatorsInProgress();if(s===0){this.validationComplete()}else{this.alfLog("log","Waiting on "+s+" more validators to complete")}}},validationComplete:function o(){m.add(this._validationInProgressIndicator,"hidden");var q=this.getValue();var p=!(this._required&&(q==null||q==""));if(this._validationInProgressState&&p){this.alfPublish("ALF_VALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.hideValidationFailure()}else{this.alfPublish("ALF_INVALID_CONTROL",{name:this.name,fieldId:this.fieldId});this.showValidationFailure()}this._validationInProgress=false;if(this._queuedValidationRequest===true){this.startValidation()}},regex:function i(q){var s=true;var t=c.getObject("regex",false,q);if(t!=null&&typeof t==="string"){var r=this.getValue();var p=new RegExp(t);s=p.test(r);if(q.invertRule===true){s=!s}}else{this.alfLog("warn","A regex validation was configured with an invalid 'regex' attribute",q,this)}this.reportValidationResult(q,s)},maxLength:function f(p){var s=true;var q=c.getObject("length",false,p);if(q!=null&&!isNaN(q)){var r=this.getValue();s=r.length<=q}else{this.alfLog("warn","A maxLength validation was configured with an invalid 'length' attribute",p,this)}this.reportValidationResult(p,s)},minLength:function j(p){var s=true;var q=c.getObject("length",false,p);if(q!=null&&!isNaN(q)){var r=this.getValue();s=r.length>=q}else{this.alfLog("warn","A minLength validation was configured with an invalid 'length' attribute",p,this)}this.reportValidationResult(p,s)},_validateUniqueConfig:null,validateUnique:function b(q){var p=this.generateUuid();var r=(q.publishPayload)?c.clone(q.publishPayload):{};r.alfResponseTopic=p;this._validateUniqueConfig=q;this._validateUniqueHandle=this.alfSubscribe(p+"_SUCCESS",c.hitch(this,this.onValidationUniqueResponse),true);this.alfPublish(q.publishTopic,r,true);return true},onValidationUniqueResponse:function g(s){this.alfUnsubscribeSaveHandles([this._validateUniqueHandle]);var u=false;var q=this._validateUniqueConfig;this._validateUniqueConfig=null;if(s!=null){var t=c.getObject("itemsProperty",false,q);if(t==null){t="items"}var r=this.getValue();var p=c.getObject(t,false,s);if(p==null){this.alfLog("warn","Attempting to validate uniqueness but 'itemsProperty' attribute doesn't map to an an array",q,this)}else{u=l.some(p,function(w,v){var x=c.getObject(this.name,false,w);return x==r},this)}}this.reportValidationResult(q,!u)}})});