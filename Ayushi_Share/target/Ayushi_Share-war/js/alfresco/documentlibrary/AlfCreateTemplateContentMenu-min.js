define(["dojo/_base/declare","alfresco/menus/AlfCascadingMenu","alfresco/documentlibrary/_AlfCreateContentPermissionsMixin","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/core/CoreXhr","alfresco/menus/AlfMenuGroup","alfresco/menus/AlfMenuItem","dojo/_base/lang","dojo/_base/array","service/constants/Default"],function(k,b,a,j,h,o,f,d,n,e){return k([b,a,j,h],{i18nRequirements:[{i18nFile:"./i18n/AlfCreateTemplateContentMenu.properties"}],widgets:[{name:"alfresco/header/AlfMenuItem",config:{iconClass:"alf-loading-icon",label:"loading.label"}}],postCreate:function i(){this.alfSubscribe(this.hashChangeTopic,d.hitch(this,this.onFilterChange));this.alfSubscribe(this.userAccessChangeTopic,d.hitch(this,this.onUserAcess));this.inherited(arguments);if(this.label){this.set("label",this.message(this.label))}else{this.set("label",this.message("menu.label"))}if(this.popup){this.popup.onOpen=dojo.hitch(this,"loadTemplates")}else{this.alfLog("error","No menu popup - something has gone wrong!")}},_templatesUrl:null,_templatesAlreadyLoaded:false,loadTemplates:function m(){if(this._templatesAlreadyLoaded){this.alfLog("log","Templates already loaded")}else{this.alfLog("log","Loading templates");var r=this._templatesUrl;if(r==null){r=e.PROXY_URI+"slingshot/doclib/node-templates"}this.serviceXhr({url:r,method:"GET",successCallback:this._templatesLoaded,failureCallback:this._templatesLoadFailed,callbackScope:this})}},_templatesLoaded:function q(s,r){this.alfLog("log","Templates data loaded successfully",s);this._templatesAlreadyLoaded=true;var t=(this.popup&&this.popup.getChildren().length>0&&this.popup.getChildren()[0].focused);var v=this;n.forEach(this.popup.getChildren(),function(x,w){v.popup.removeChild(x)});if(s.data){if(s.data.length>0){var u=new o({});this.popup.addChild(u);n.forEach(s.data,dojo.hitch(this,"_addMenuItem",u))}else{this.addNoTemplatesMessageItem()}}if(t){this.popup.focusFirstChild()}},_templatesLoadFailed:function l(s,r){this.alfLog("error","Could not load templates menu items",s);var t=this;n.forEach(this.popup.getChildren(),function(v,u){t.popup.removeChild(v)});this.addTemplatesFailMessageItem()},addNoTemplatesMessageItem:function c(){this._templatesMessageItem=new f({label:"no.templates.label"});this.popup.addChild(this._templatesMessageItem)},addTemplatesFailMessageItem:function p(){this._templatesMessageItem=new f({label:"templates.load.error"});this.popup.addChild(this._templatesMessageItem)},templatePublishTopic:"ALF_CREATE_CONTENT",templateIconClass:"alf-textdoc-icon",_addMenuItem:function g(v,u,s){var r=(u.title!=="")?u.title:u.name;var t=new f({label:r,iconClass:this.templateIconClass,publishTopic:this.templatePublishTopic,publishPayload:{type:"template",params:{nodeRef:u.nodeRef}}});v.addChild(t)}})});