define(["dojo/_base/declare","alfresco/core/Core","alfresco/documentlibrary/_AlfDocumentListTopicMixin","alfresco/core/PathUtils","dojo/_base/lang","dojo/_base/array","dojo/mouse","dojo/on","dijit/registry","dojo/dom-class","dojo/dom","dojo/_base/window"],function(B,q,b,g,E,h,p,m,i,k,x,d){return B([q,b,g],{nonAmdDependencies:["/js/yui-common.js"],dndUploadEnabled:false,dndUploadCapable:false,constructor:function n(){this.dndUploadCapable=("draggable" in document.createElement("span"))},removeUploadDragAndDrop:function y(F){this.alfLog("log","Removing drag and drop upload handlers");if(this.dndUploadEventHandlers!=null){h.forEach(this.dndUploadEventHandlers,function(G){G.remove()})}this.dndUploadEventHandlers=[]},dragAndDropNode:null,dndUploadEventHandlers:null,subscribeToCurrentNodeChanges:function j(F){if(this.dndUploadCapable){this.dragAndDropNode=F;this.alfSubscribe(this.metadataChangeTopic,E.hitch(this,this.onCurrentNodeChange));this.alfSubscribe(this.hashChangeTopic,E.hitch(this,this.onFilterChange))}},onCurrentNodeChange:function w(G){if(G&&G.node){this.alfLog("log","Updating current nodeRef to: ",G.node);this._currentNode=G.node;var F=E.getObject("node.parent.permissions.user.CreateChildren",false,G);if(F===true){this.addUploadDragAndDrop(this.dragAndDropNode)}else{this.removeUploadDragAndDrop(this.dragAndDropNode)}}else{this.alfLog("error","A request was made to update the current NodeRef, but no 'node' property was provided in the payload: ",G)}},onFilterChange:function l(G){var F=E.getObject("path",false,G);if(F==null){this.removeUploadDragAndDrop(this.dragAndDropNode)}else{this.addUploadDragAndDrop(this.dragAndDropNode)}},hasUploadPermissions:function f(){var G=E.getObject("currentItem.jsNode.isContainer",false,this);var F=E.getObject("currentItem.jsNode.permissions.user",false,this);return((G===true&&F.CreateChildren===true)||(G===false&&F.Write===true))},addUploadDragAndDrop:function v(G){if(this.dndUploadCapable){this.alfLog("log","Adding DND upload capabilities",this);try{this.dndUploadEnabled=true;this.dragAndDropNode=G;if(this.dndUploadEventHandlers!=null){h.forEach(this.dndUploadEventHandlers,function(H){H.remove()})}this.dndUploadEventHandlers=[];this.dndUploadEventHandlers.push(m(d.body(),"dragenter",E.hitch(this,"onDndUploadDragEnter")));this.dndUploadEventHandlers.push(m(this.dragAndDropNode,"dragover",E.hitch(this,"onDndUploadDragOver")));this.dndUploadEventHandlers.push(m(this.dragAndDropNode,"drop",E.hitch(this,"onDndUploadDrop")));this.alfLog("log","Handlers: ",this.dndUploadEventHandlers)}catch(F){this.alfLog("error","The following exception occurred adding Drag and Drop event handlers: ",F)}}else{this.alfLog("log","Cannot add DND upload capabilities because the browser does not have the required capabilities",this)}},swallowDragStart:function s(F){F.stopPropagation();F.preventDefault()},swallowDragEnter:function c(F){F.stopPropagation();F.preventDefault()},swallowDragOver:function r(F){F.dataTransfer.dropEffect="none";F.stopPropagation();F.preventDefault()},swallowDrop:function u(F){this.alfLog("log","Swallowing drop");F.stopPropagation();F.preventDefault()},onDndUploadDragEnter:function e(F){if(x.isDescendant(F.target,this.dragAndDropNode)&&this.checkApplicable(F.target,"onDndUploadDragEnter")){this.alfLog("log","Adding DND highlight",this);this.addDndHighlight()}else{this.alfLog("log","Removing DND highlight",this);this.removeDndHighlight()}},onDndUploadDragOver:function o(F){F.stopPropagation();F.preventDefault()},addDndHighlight:function A(){if(this.domNode!=null){k.add(this.domNode,"dndHighlight")}},removeDndHighlight:function A(){if(this.domNode!=null){k.remove(this.domNode,"dndHighlight")}},checkApplicable:function a(G,I){var F=false;var H=i.getEnclosingWidget(G);if(H==null){this.alfLog("log","No widget found - unexpected behaviour: ",this)}else{if(H!=this&&typeof H[I]==="function"&&H.dndUploadEnabled!=null&&H.dndUploadEnabled===true){this.alfLog("log","This event does NOT relate to me: ",this)}else{this.alfLog("log","This event relates to me: ",this);F=true}}return F},onDndUploadDrop:function C(H){try{this.alfLog("log","Upload drop detected",H);if(H.dataTransfer.files!==undefined&&H.dataTransfer.files!==null&&H.dataTransfer.files.length>0){this.removeDndHighlight();var J=this.getUploadConfig();var G={siteId:null,containerId:null,uploadDirectory:null,updateNodeRef:null,description:"",overwrite:false,thumbnails:"doclib",username:null};var F=E.mixin(G,J);if(F.overwrite===false){var I=this.generateUuid();this._uploadSubHandle=this.alfSubscribe(I,E.hitch(this,this.onFileUploadComplete),true);this.alfPublish("ALF_UPLOAD_REQUEST",{alfResponseTopic:I,files:H.dataTransfer.files,targetData:F},true)}else{this.publishUpdateRequest(F,H.dataTransfer.files)}}else{this.alfLog("error","A drop event was detected, but no files were present for upload: ",H.dataTransfer)}}catch(K){this.alfLog("error","The following error occurred when files were dropped onto the Document List: ",K)}this.removeDndHighlight();H.stopPropagation();H.preventDefault()},publishUpdateRequest:function t(F,H){var G=this.generateUuid();this._uploadSubHandle=this.alfSubscribe(G,E.hitch(this,this.onFileUploadComplete),true);var I=this.generateUuid();this.alfSetData(I,H);this.alfPublish("ALF_CREATE_FORM_DIALOG_REQUEST",{dialogTitle:"Update",dialogConfirmationButtonTitle:"Continue Update",dialogCancellationButtonTitle:"Cancel",formSubmissionTopic:"ALF_UPLOAD_REQUEST",formSubmissionPayloadMixin:{alfResponseTopic:G,filesRefs:I,targetData:F},fixedWidth:true,widgets:E.clone(this.widgetsForUpdate)},true)},widgetsForUpdate:[{name:"alfresco/forms/controls/DojoRadioButtons",config:{label:"This version has",name:"targetData.majorVersion",value:"false",optionsConfig:{fixed:[{label:"Minor changes",value:"false"},{label:"Major changes",value:"true"}]}}},{name:"alfresco/forms/controls/TinyMCE",config:{label:"Comments",name:"targetData.description",value:""}}],getUploadConfig:function z(){var F=null;if(this.currentItem&&this.currentItem.jsNode&&this.currentItem.jsNode.isContainer){try{F={destination:this.currentItem.nodeRef}}catch(G){this.alfLog("warn","Failed to generate upload configuration",G)}}else{if(this.currentItem&&this.currentItem.jsNode&&this.currentItem.jsNode.isContainer===false){try{F={updateNodeRef:this.currentItem.nodeRef,overwrite:true,majorVersion:false,destination:null}}catch(G){this.alfLog("warn","Failed to generate upload configuration",G)}}else{if(this._currentNode&&this._currentNode.parent&&this._currentNode.parent.nodeRef){try{F={destination:this._currentNode.parent.nodeRef}}catch(G){this.alfLog("warn","Failed to generate upload configuration",G)}}}}return F},onFileUploadComplete:function D(){this.alfLog("log","Upload complete");this.alfUnsubscribeSaveHandles([this._uploadSubHandle]);this.alfPublish(this.reloadDataTopic,{},false,this.publishToParent)}})});