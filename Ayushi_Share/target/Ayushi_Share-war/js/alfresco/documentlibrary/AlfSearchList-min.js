define(["dojo/_base/declare","alfresco/lists/AlfSortablePaginatedList","dojo/_base/array","dojo/_base/lang","dojo/hash","dojo/io-query","alfresco/core/ArrayUtils"],function(u,j,h,y,b,t,d){return u([j],{i18nRequirements:[{i18nFile:"./i18n/AlfSearchList.properties"}],cssRequirements:[{cssFile:"./css/AlfSearchList.css"}],setupSubscriptions:function e(){this.inherited(arguments);this.alfSubscribe("ALF_SET_SEARCH_TERM",y.hitch(this,this.onSearchTermRequest));this.alfSubscribe("ALF_INCLUDE_FACET",y.hitch(this,this.onIncludeFacetRequest));this.alfSubscribe("ALF_APPLY_FACET_FILTER",y.hitch(this,this.onApplyFacetFilter));this.alfSubscribe("ALF_REMOVE_FACET_FILTER",y.hitch(this,this.onRemoveFacetFilter));this.alfSubscribe("ALF_SEARCHLIST_SCOPE_SELECTION",y.hitch(this,this.onScopeSelection));this.alfSubscribe("ALF_ADVANCED_SEARCH",y.hitch(this,this.onAdvancedSearch));this.alfSubscribe(this.reloadDataTopic,y.hitch(this,this.reloadData))},setDisplayMessages:function m(){this.noViewSelectedMessage=this.message("searchlist.no.view.message");this.noDataMessage=this.message("searchlist.no.data.message");this.fetchingDataMessage=this.message("searchlist.loading.data.message");this.renderingViewMessage=this.message("searchlist.rendering.data.message");this.fetchingMoreDataMessage=this.message("searchlist.loading.data.message");this.dataFailureMessage=this.message("searchlist.data.failure.message")},spellcheck:true,postMixInProperties:function f(){this.inherited(arguments);this._suspendSpellCheck=false;this._cleanResettableVars()},reloadData:function r(){this.resetResultsList();this.loadData()},searchTerm:"",onSearchTermRequest:function x(B){this.alfLog("log","Setting search term",B,this);var A=y.getObject("searchTerm",false,B);if(A==null){this.alfLog("warn","No searchTerm provided on request",B,this)}else{if(A===this.searchTerm){if(this.requestInProgress===true){}else{if(B.spellcheck!=null&&B.spellcheck===false){this._suspendSpellCheck=true}var z=t.queryToObject(b());if(this._cleanResettableHashTerms(z)){z.searchTerm=this.searchTerm;this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:t.objectToQuery(z),type:"HASH"},true)}else{this.resetResultsList();this.loadData()}}}else{this.searchTerm=A;var z=t.queryToObject(b());this._cleanResettableHashTerms(z);z.searchTerm=this.searchTerm;this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:t.objectToQuery(z),type:"HASH"},true)}}},onAdvancedSearch:function w(z){this.resetResultsList();this.searchTerm=z.searchTerm;delete z.searchTerm;this.query=z;this.loadData()},selectedScope:"repo",onScopeSelection:function g(B){this.alfLog("log","Scope selection received",B,this);var A=y.getObject("value",false,B);if(A==null){this.alfLog("warn","No 'value' attribute provided in scope selection payload",B,this)}else{if(A===this.selectedScope){this.alfLog("log","Scope requested is currently set",A,this)}else{var z=t.queryToObject(b());this.selectedScope=A;z.scope=A;if(A==="repo"||A==="all_sites"){this.siteId=""}else{this.siteId=A}this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:t.objectToQuery(z),type:"HASH"},true)}}},facetFields:"",hideFacets:true,onIncludeFacetRequest:function i(C){this.alfLog("log","Adding facet filter",C,this);var D=y.getObject("qname",false,C);var z=y.getObject("blockIncludeFacetRequest",false,C);if(D==null){this.alfLog("warn","No qname provided when adding facet field",C,this)}else{if(z!=null&&z===true){this.hideFacets=false}else{this.hideFacets=false;var A=this.facetFields.split(",");var B=h.some(A,function(E,F){return E===D});if(B){}else{this.facetFields=(this.facetFields!=="")?this.facetFields+","+D:D}}}},facetFilters:null,onApplyFacetFilter:function q(A){this.alfLog("log","Filtering on facet",A,this);var z=y.getObject("filter",false,A);if(z==null){this.alfLog("warn","No filter provided when filtering by facet",A,this)}else{this.facetFilters[z]=true;this.updateFilterHash(z,"add")}},onRemoveFacetFilter:function n(z){this.alfLog("log","Removing facet filter",z,this);delete this.facetFilters[z.filter];this.updateFilterHash(z.filter,"remove")},updateFilterHash:function k(C,D){var B=t.queryToObject(b()),z=((B.facetFilters)?B.facetFilters:""),A=(z==="")?[]:z.split(",");if(D==="add"&&!d.arrayContains(A,C)){A.push(C)}else{if(D==="remove"&&d.arrayContains(A,C)){A.splice(A.indexOf(C),1)}}if(A.length<1){delete B.facetFilters}else{B.facetFilters=A.join()}this.alfPublish("ALF_NAVIGATE_TO_PAGE",{url:t.objectToQuery(B),type:"HASH"},true)},onHashChanged:function l(C){this.alfLog("log","Hash change detected",C,this);if(this._payloadContainsUpdateableVar(C)){var z=y.getObject("searchTerm",false,C);if(z!=this.searchTerm){this._cleanResettableVars()}var B=y.getObject("facetFilters",false,C);if(B!=null){var A=C.facetFilters={};var D=B.split(",");h.forEach(D,function(E){A[E]=true},this)}else{this._cleanResettableVars()}y.mixin(this,C);this.resetResultsList();this.loadData()}},loadData:function a(){if(this.requestInProgress&&this.blockConcurrentRequests){this.alfLog("log","Search request ignored because progress is already in progress")}else{if(this.currentRequestId){this.alfPublish("ALF_STOP_SEARCH_REQUEST",{requestId:this.currentRequestId},true)}var D=0;if(this.useInfiniteScroll){D=(this.currentPage-1)*this.currentPageSize}if(!this.useInfiniteScroll||this.currentData==null||this.currentData.totalRecordsUpper>=D){this.alfPublish(this.requestInProgressTopic,{});this.showLoadingMessage();var A="";for(var z in this.facetFilters){A=A+z.replace(/\.__.u/g,"").replace(/\.__/g,"")+","}A=A.substring(0,A.length-1);var B=(this.scope==="repo"||this.scope==="all_sites")?"":this.scope;this.currentRequestId=this.generateUuid();var C={term:this.searchTerm,facetFields:this.facetFields,filters:A,sortAscending:this.sortAscending,sortField:this.sortField,site:B,rootNode:this.rootNode,repo:this.scope==="repo",requestId:this.currentRequestId,pageSize:this.currentPageSize,startIndex:D,spellcheck:this.spellcheck&&!this._suspendSpellCheck};if(this.query){delete this.query.alfTopic;if(typeof this.query==="string"){this.query=JSON.parse(this.query)}for(var z in this.query){C[z]=this.query[z]}}C.alfResponseTopic=this.pubSubScope+"ALF_RETRIEVE_DOCUMENTS_REQUEST";this.alfPublish("ALF_SEARCH_REQUEST",C,true)}else{this.alfLog("log","No more data to to retrieve, cancelling search request",this)}}},onDataLoadSuccess:function s(F){this.alfLog("log","Search Results Loaded",F,this);var C=F.response;this.currentData=C;this._suspendSpellCheck=false;var z=this.viewMap[this._currentlySelectedView];if(z!=null){this.showRenderingMessage();if(this.useInfiniteScroll){z.augmentData(C);this.currentData=z.getData()}else{z.setData(C)}z.renderView(this.useInfiniteScroll);this.showView(z)}var E=y.getObject("response.facets",false,F);var D=y.getObject("requestConfig.query.filters",false,F);if(E!=null){for(var A in E){var G=A;if(A[0]==="@"){G=A.substring(1)}this.alfPublish("ALF_FACET_RESULTS_"+G,{facetResults:E[A],activeFilters:D})}}this.handleSpellCheck(F);var B=this.currentData.numberFound!=-1?this.currentData.numberFound:0;if(B!=null){this.alfPublish("ALF_SEARCH_RESULTS_COUNT",{count:B,label:this.message("faceted-search.results-menu.results-found",{0:B})})}this.alfPublish("ALF_HIDE_FACETS",{hide:(this.hideFacets===true||B===0)});this.alfPublish(this.requestFinishedTopic,{});this.alfPublish("ALF_RESIZE_SIDEBAR",{})},handleSpellCheck:function p(B){var A=y.getObject("response.spellcheck",false,B);if(A!=null){if(A.searchedFor!=null){this.alfPublish("ALF_SPELL_CHECK_SEARCH_TERM",{searchRequest:A.searchRequest,searchedFor:A.searchedFor})}else{if(A.searchSuggestions!=null){var z=[];h.forEach(A.searchSuggestions,function(C,D){z.push({term:C})});this.alfPublish("ALF_SPELL_CHECK_SEARCH_SUGGESTIONS",{searchRequest:A.searchRequest,searchSuggestions:z})}else{}}}},resetResultsList:function v(){this.startIndex=0;this.currentPage=1;this.hideChildren(this.domNode);this.clearViews()},_resetVars:["facetFilters","query"],_cleanResettableVars:function o(){for(var z=0;z<this._resetVars.length;z++){this[this._resetVars[z]]={}}},_cleanResettableHashTerms:function c(z){var B=false;for(var A in z){if(this._resetVars.indexOf(A)!=-1&&z[A]!=null&&z[A]!==""){B=true;delete z[A]}}return B}})});