define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dojo/text!./templates/ChartsView.html","./Chart","alfresco/core/Core","alfresco/core/CoreWidgetProcessing","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-class","dojo/date","dojo/date/stamp"],function(g,j,m,l,h,d,b,c,i,f,k,e,a){return g([j,m,d,b],{baseClass:"alfresco-charts-ccc-ChartsView",templateString:l,chartsNode:null,subscriptionTopic:null,dataRequestTopic:null,dataRequestPayload:{},_currentDataRequestPayload:{},_chart:null,_chartMap:null,chartSelectionTopic:null,_currentlySelectedChart:null,postMixInProperties:function(){if(this.subscriptionTopic){this.alfSubscribe(this.subscriptionTopic,c.hitch(this,this.onSubscriptionTopic))}if(this.dataRequestTopic){this.alfSubscribe(this.dataRequestTopic+"_SUCCESS",c.hitch(this,this.onDataRequestTopicSuccess));this.alfSubscribe(this.dataRequestTopic+"_FAILURE",c.hitch(this,this.onDataRequestTopicFailure))}},allWidgetsProcessed:function(n){i.forEach(n,c.hitch(this,this.registerChart));if(this.chartSelectionTopic){this.alfPublish(this.chartSelectionTopic,{value:this._currentlySelectedChart})}this._currentDataRequestPayload=c.mixin({},this.dataRequestPayload);this.requestData()},postCreate:function(){this._chartMap={};if(this.widgets){this.processWidgets(this.widgets)}},requestData:function(){this._currentDataRequestPayload.alfResponseTopic=this.dataRequestTopic;this.alfPublish(this.dataRequestTopic,this._currentDataRequestPayload)},onDataRequestTopic:function(p,n){var o=this._chartMap[this._currentlySelectedChart];if(o!=null){o.showData(p,n);this.showChart(o)}},onDataRequestTopicSuccess:function(n){this.onDataRequestTopic(n.response.data,n.response.dataDescriptor)},onDataRequestTopicFailure:function(){this.onDataRequestTopic({},{})},onSubscriptionTopic:function(r){var o=a.toISOString(new Date(),{selector:"date"});var n=r.startDate,q=r.endDate;var p=function(t){switch(t){case"TODAY":return o;case"7D":return a.toISOString(e.add(new Date(),"day",-7),{selector:"date"});case"30D":return a.toISOString(e.add(new Date(),"day",-30),{selector:"date"});case"YEAR":return a.toISOString(e.add(new Date(),"year",-1),{selector:"date"});case"CUSTOM":return n;default:break}return n};var s=function(t){if(t=="CUSTOM"){return q}else{return o}};if(r.timePeriod){r.startDate=p(r.timePeriod);r.endDate=s(r.timePeriod)}c.mixin(this._currentDataRequestPayload,r);this.requestData()},registerChart:function(p,o){if(p instanceof h){this.alfLog("log","Registering Chart",p);var n=o;if(n==this._chart||(!this._currentlySelectedChart&&!this._chart)){this._currentlySelectedChart=n}this._chartMap[n]=p}else{this.alfLog("warn","The following widget was provided as a chart, but it does not inherit from 'alfresco/charts/ccc/Chart'",p)}},showChart:function(n){this.hideChildren(this.domNode);if(this.chartsNode.children.length>0){this.chartsNode.removeChild(this.chartsNode.children[0])}f.place(n.domNode,this.chartsNode);k.remove(this.chartsNode,"share-hidden")},hideChildren:function(n){i.forEach(n.children,function(o){k.add(o,"share-hidden")})}})});