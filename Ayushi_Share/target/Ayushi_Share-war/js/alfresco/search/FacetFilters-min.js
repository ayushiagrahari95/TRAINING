define(["dojo/_base/declare","alfresco/documentlibrary/AlfDocumentFilters","alfresco/search/FacetFilter","dojo/_base/lang","dojo/_base/array","dojo/dom-class","dojo/on","dijit/registry"],function(o,e,q,r,h,k,l,i){return o([e],{filterPrefsName:"docListFilterPref",facetQName:null,maxFilters:null,hitThreshold:null,minFilterValueLength:null,sortBy:"ALPHABETICALLY",useHash:false,postCreate:function a(){this.inherited(arguments);this.alfSubscribe("ALF_WIDGETS_READY",r.hitch(this,"publishFacets"),true)},blockIncludeFacetRequest:false,publishFacets:function p(){if(this.facetQName!=null&&this.facetQName!==""){this.alfPublish("ALF_INCLUDE_FACET",{qname:this.facetQName,blockIncludeFacetRequest:this.blockIncludeFacetRequest},true);this.alfSubscribe("ALF_FACET_RESULTS_"+this.facetQName,r.hitch(this,"processFacetFilters"))}else{this.alfLog("warn","No facet QNname was provided for a filter",this)}},processFacetFilters:function m(w){this.alfLog("log","Facet Results received!",w,this);this.moreFiltersList=null;k.add(this.showMoreNode,"hidden");k.add(this.showLessNode,"hidden");var u=i.findWidgets(this.filtersNode);h.forEach(u,function(A,z){A.destroy()});var y=[];if(w.activeFilters!=null){y=w.activeFilters.split(",")}var v=[];for(var t in w.facetResults){var x=w.facetResults[t];v.push({label:x.label,value:x.value,hits:x.hits,index:x.index})}v=this.sortFacetFilters(v);v=h.filter(v,r.hitch(this,this.filterFacetFilters));var s=this.maxFilters;h.forEach(v,function(B,A){if(this.minFilterValueLength!=null&&B.value.length<this.minFilterValueLength){}else{if(this.hitThreshold==null||this.hitThreshold<=B.hits){var C=h.some(y,function(E,D){return E==this.facetQName.replace(/\.__.u/g,"").replace(/\.__/g,"")+"|"+B.value},this);var z=new q({label:B.label,hits:B.hits,filter:B.value,facet:this.facetQName,applied:C,useHash:this.useHash,pubSubScope:this.pubSubScope});if(s!=null&&s<=0&&!C){this.addMoreFilter(z)}z.placeAt(this.showMoreNode,"before");if(s!=null){s--}}}},this);if(this.moreFiltersList!=null){k.remove(this.showMoreNode,"hidden")}if(v.length===0){k.add(this.domNode,"hidden")}else{k.remove(this.domNode,"hidden")}},filterFacetFilters:function b(t,s){return((this.hitThreshold==null||this.hitThreshold<=t.hits)&&(this.minFilterValueLength==null||t.value.length>=this.minFilterValueLength))},sortFacetFilters:function n(s){if(this.sortBy==null||r.trim(this.sortBy)==="ALPHABETICALLY"){return s.sort(this._alphaSort)}else{if(r.trim(this.sortBy)==="REVERSE_ALPHABETICALLY"){return s.sort(this._reverseAlphaSort)}else{if(r.trim(this.sortBy)==="ASCENDING"){return s.sort(this._ascSort)}else{if(r.trim(this.sortBy)==="DESCENDING"){return s.sort(this._descSort)}else{if(r.trim(this.sortBy)==="INDEX"){return s.sort(this._indexSort)}else{return s}}}}}},_alphaSort:function j(t,s){var u=t.label.toLowerCase();var v=s.label.toLowerCase();if(u<v){return -1}if(u>v){return 1}return 0},_reverseAlphaSort:function d(t,s){var u=t.label.toLowerCase();var v=s.label.toLowerCase();if(u>v){return -1}if(u<v){return 1}return 0},_ascSort:function c(t,s){return s.hits-t.hits},_descSort:function f(t,s){return t.hits-s.hits},_indexSort:function g(t,s){if(t.index!=null&&s.index!=null){return t.index-s.index}else{return 0}}})});