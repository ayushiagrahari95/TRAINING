(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("diff_match_patch"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","diff_match_patch"],a)}else{a(CodeMirror,diff_match_patch)}}})(function(B,g){var t=B.Pos;var h="http://www.w3.org/2000/svg";function l(I,J){this.mv=I;this.type=J;this.classes=J=="left"?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}l.prototype={constructor:l,init:function(K,J,I){this.edit=this.mv.edit;this.orig=B(K,x({value:J,readOnly:!this.mv.options.allowEditingOriginals},x(I)));this.diff=b(p(J),p(I.value));this.diffOutOfDate=false;this.showDifferences=I.showDifferences!==false;this.forceUpdate=D(this);F(this,true,false);q(this)},setShowDifferences:function(I){I=I!==false;if(I!=this.showDifferences){this.showDifferences=I;this.forceUpdate("full")}}};function A(I){if(I.diffOutOfDate){I.diff=b(I.orig.getValue(),I.edit.getValue());I.diffOutOfDate=false;B.signal(I.edit,"updateDiff",I.diff)}}function D(I){var J={from:0,to:0,marked:[]};var O={from:0,to:0,marked:[]};var N;function M(P){if(P=="full"){if(I.svg){w(I.svg)}if(I.copyButtons){w(I.copyButtons)}c(I.edit,J.marked,I.classes);c(I.orig,O.marked,I.classes);J.from=J.to=O.from=O.to=0}A(I);if(I.showDifferences){v(I.edit,I.diff,J,DIFF_INSERT,I.classes);v(I.orig,I.diff,O,DIFF_DELETE,I.classes)}r(I)}function L(P){clearTimeout(N);N=setTimeout(M,P==true?250:100)}function K(){if(!I.diffOutOfDate){I.diffOutOfDate=true;J.from=J.to=O.from=O.to=0}L(true)}I.edit.on("change",K);I.orig.on("change",K);I.edit.on("markerAdded",L);I.edit.on("markerCleared",L);I.orig.on("markerAdded",L);I.orig.on("markerCleared",L);I.edit.on("viewportChange",L);I.orig.on("viewportChange",L);M();return M}function q(I){I.edit.on("scroll",function(){E(I,DIFF_INSERT)&&r(I)});I.orig.on("scroll",function(){E(I,DIFF_DELETE)&&r(I)})}function E(U,M){if(U.diffOutOfDate){return false}if(!U.lockScroll){return true}var N,P,K=+new Date;if(M==DIFF_INSERT){N=U.edit;P=U.orig}else{N=U.orig;P=U.edit}if(N.state.scrollSetBy==U&&(N.state.scrollSetAt||0)+50>K){return false}var I=N.getScrollInfo(),J=0.5*I.clientHeight,S=I.top+J;var Y=N.lineAtHeight(S,"local");var W=H(U.diff,Y,M==DIFF_INSERT);var Z=s(N,M==DIFF_INSERT?W.edit:W.orig);var R=s(P,M==DIFF_INSERT?W.orig:W.edit);var Q=(S-Z.top)/(Z.bot-Z.top);var L=(R.top-J)+Q*(R.bot-R.top);var O,T;if(L>I.top&&(T=I.top/J)<1){L=L*T+I.top*(1-T)}else{if((O=I.height-I.clientHeight-I.top)<J){var X=P.getScrollInfo();var V=X.height-X.clientHeight-L;if(V>O&&(T=O/J)<1){L=L*T+(X.height-X.clientHeight-O)*(1-T)}}}P.scrollTo(I.left,L);P.state.scrollSetAt=K;P.state.scrollSetBy=U;return true}function s(I,J){var K=J.after;if(K==null){K=I.lastLine()+1}return{top:I.heightAtLine(J.before||0,"local"),bot:I.heightAtLine(K,"local")}}function F(I,K,J){I.lockScroll=K;if(K&&J!=false){E(I,DIFF_INSERT)&&r(I)}I.lockButton.innerHTML=K?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function c(L,I,K){for(var J=0;J<I.length;++J){var M=I[J];if(M instanceof B.TextMarker){M.clear()}else{if(M.parent){L.removeLineClass(M,"background",K.chunk);L.removeLineClass(M,"background",K.start);L.removeLineClass(M,"background",K.end)}}}I.length=0}function v(L,N,M,K,J){var I=L.getViewport();L.operation(function(){if(M.from==M.to||I.from-M.to>20||M.from-I.to>20){c(L,M.marked,J);o(L,N,K,M.marked,I.from,I.to,J);M.from=I.from;M.to=I.to}else{if(I.from<M.from){o(L,N,K,M.marked,I.from,M.from,J);M.from=I.from}if(I.to>M.to){o(L,N,K,M.marked,M.to,I.to,J);M.to=I.to}}})}function o(P,S,O,Y,X,K,aa){var Q=t(0,0);var U=t(X,0),T=P.clipPos(t(K-1));var I=O==DIFF_DELETE?aa.del:aa.insert;function R(aj,af){var ai=Math.max(X,aj),ag=Math.min(K,af);for(var ah=ai;ah<ag;++ah){var ae=P.addLineClass(ah,"background",aa.chunk);if(ah==aj){P.addLineClass(ae,"background",aa.start)}if(ah==af-1){P.addLineClass(ae,"background",aa.end)}Y.push(ae)}if(aj==af&&ai==af&&ag==af){if(ai){Y.push(P.addLineClass(ai-1,"background",aa.end))}else{Y.push(P.addLineClass(ai,"background",aa.start))}}}var ad=0;for(var Z=0;Z<S.length;++Z){var W=S[Z],J=W[0],V=W[1];if(J==DIFF_EQUAL){var N=Q.line+(d(S,Z)?0:1);u(Q,V);var M=Q.line+(i(S,Z)?1:0);if(M>N){if(Z){R(ad,N)}ad=M}}else{if(J==O){var L=u(Q,V,true);var ac=m(U,Q),ab=k(T,L);if(!j(ac,ab)){Y.push(P.markText(ac,ab,{className:I}))}Q=L}}}if(ad<=Q.line){R(ad,Q.line+1)}}function r(L){if(!L.showDifferences){return}if(L.svg){w(L.svg);var J=L.gap.offsetWidth;y(L.svg,"width",J,"height",L.gap.offsetHeight)}if(L.copyButtons){w(L.copyButtons)}var N=L.type=="left";var O=L.edit.getViewport(),K=L.orig.getViewport();var I=L.edit.getScrollInfo().top,M=L.orig.getScrollInfo().top;e(L.diff,function(U,W,X,T){if(X>O.to||T<O.from||U>K.to||W<K.from){return}var P=L.orig.heightAtLine(U,"local")-M,aa=P;if(L.svg){var S=L.edit.heightAtLine(X,"local")-I;if(N){var V=P;P=S;S=V}var Y=L.orig.heightAtLine(W,"local")-M;var ac=L.edit.heightAtLine(T,"local")-I;if(N){var V=Y;Y=ac;ac=V}var ae=" C "+J/2+" "+S+" "+J/2+" "+P+" "+(J+2)+" "+P;var ab=" C "+J/2+" "+Y+" "+J/2+" "+ac+" -1 "+ac;y(L.svg.appendChild(document.createElementNS(h,"path")),"d","M -1 "+S+ae+" L "+(J+2)+" "+Y+ab+" z","class",L.classes.connect)}if(L.copyButtons){var Q=L.copyButtons.appendChild(f("div",L.type=="left"?"\u21dd":"\u21dc","CodeMirror-merge-copy"));var R=L.mv.options.allowEditingOriginals;Q.title=R?"Push to left":"Revert chunk";Q.chunk={topEdit:X,botEdit:T,topOrig:U,botOrig:W};Q.style.top=aa+"px";if(R){var ad=L.orig.heightAtLine(X,"local")-I;var Z=L.copyButtons.appendChild(f("div",L.type=="right"?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse"));Z.title="Push to right";Z.chunk={topEdit:U,botEdit:W,topOrig:X,botOrig:T};Z.style.top=ad+"px";L.type=="right"?Z.style.left="2px":Z.style.right="2px"}}})}function G(J,L,K,I){if(J.diffOutOfDate){return}L.replaceRange(K.getRange(t(I.topOrig,0),t(I.botOrig,0)),t(I.topEdit,0),t(I.botEdit,0))}var C=B.MergeView=function(N,W){if(!(this instanceof C)){return new C(N,W)}this.options=W;var Q=W.origLeft,O=W.origRight==null?W.orig:W.origRight;var T=Q!=null,X=O!=null;var R=1+(T?1:0)+(X?1:0);var K=[],M=this.left=null,U=this.right=null;if(T){M=this.left=new l(this,"left");var J=f("div",null,"CodeMirror-merge-pane");K.push(J);K.push(z(M))}var P=f("div",null,"CodeMirror-merge-pane");K.push(P);if(X){U=this.right=new l(this,"right");K.push(z(U));var S=f("div",null,"CodeMirror-merge-pane");K.push(S)}(X?S:P).className+=" CodeMirror-merge-pane-rightmost";K.push(f("div",null,null,"height: 0; clear: both;"));var L=this.wrap=N.appendChild(f("div",K,"CodeMirror-merge CodeMirror-merge-"+R+"pane"));this.edit=B(P,x(W));if(M){M.init(J,Q,W)}if(U){U.init(S,O,W)}var I=function(){if(M){r(M)}if(U){r(U)}};B.on(window,"resize",I);var V=setInterval(function(){for(var Y=L.parentNode;Y&&Y!=document.body;Y=Y.parentNode){}if(!Y){clearInterval(V);B.off(window,"resize",I)}},5000)};function z(L){var K=L.lockButton=f("div",null,"CodeMirror-merge-scrolllock");K.title="Toggle locked scrolling";var M=f("div",[K],"CodeMirror-merge-scrolllock-wrap");B.on(K,"click",function(){F(L,!L.lockScroll)});var J=[M];if(L.mv.options.revertButtons!==false){L.copyButtons=f("div",null,"CodeMirror-merge-copybuttons-"+L.type);B.on(L.copyButtons,"click",function(O){var N=O.target||O.srcElement;if(!N.chunk){return}if(N.className=="CodeMirror-merge-copy-reverse"){G(L,L.orig,L.edit,N.chunk);return}G(L,L.edit,L.orig,N.chunk)});J.unshift(L.copyButtons)}var I=document.createElementNS&&document.createElementNS(h,"svg");if(I&&!I.createSVGRect){I=null}L.svg=I;if(I){J.push(I)}return L.gap=f("div",J,"CodeMirror-merge-gap")}C.prototype={constuctor:C,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(I){if(this.right){this.right.setShowDifferences(I)}if(this.left){this.left.setShowDifferences(I)}},rightChunks:function(){return this.right&&n(this.right)},leftChunks:function(){return this.left&&n(this.left)}};function p(I){if(typeof I=="string"){return I}else{return I.getValue()}}var a=new g();function b(J,I){var M=a.diff_main(J,I);a.diff_cleanupSemantic(M);for(var L=0;L<M.length;++L){var K=M[L];if(!K[1]){M.splice(L--,1)}else{if(L&&M[L-1][0]==K[0]){M.splice(L--,1);M[L][1]+=K[1]}}}return M}function e(V,N){var S=0,R=0;var W=t(0,0),U=t(0,0);for(var K=0;K<V.length;++K){var J=V[K],T=J[0];if(T==DIFF_EQUAL){var I=d(V,K)?0:1;var M=W.line+I,L=U.line+I;u(W,J[1],null,U);var O=i(V,K)?1:0;var Q=W.line+O,P=U.line+O;if(Q>M){if(K){N(R,L,S,M)}S=Q;R=P}}else{u(T==DIFF_INSERT?W:U,J[1])}}if(S<=W.line||R<=U.line){N(R,U.line+1,S,W.line+1)}}function n(I){A(I);var J=[];e(I.diff,function(M,L,K,N){J.push({origFrom:M,origTo:L,editFrom:K,editTo:N})});return J}function i(K,I){if(I==K.length-1){return true}var J=K[I+1][1];if(J.length==1||J.charCodeAt(0)!=10){return false}if(I==K.length-2){return true}J=K[I+2][1];return J.length>1&&J.charCodeAt(0)==10}function d(K,I){if(I==0){return true}var J=K[I-1][1];if(J.charCodeAt(J.length-1)!=10){return false}if(I==1){return true}J=K[I-2][1];return J.charCodeAt(J.length-1)==10}function H(N,O,K){var J,I,M,L;e(N,function(P,U,S,Q){var R=K?S:P;var T=K?Q:U;if(I==null){if(R>O){I=S;L=P}else{if(T>O){I=Q;L=U}}}if(T<=O){J=Q;M=U}else{if(R<=O){J=S;M=P}}});return{edit:{before:J,after:I},orig:{before:M,after:L}}}function f(I,M,L,K){var N=document.createElement(I);if(L){N.className=L}if(K){N.style.cssText=K}if(typeof M=="string"){N.appendChild(document.createTextNode(M))}else{if(M){for(var J=0;J<M.length;++J){N.appendChild(M[J])}}}return N}function w(J){for(var I=J.childNodes.length;I>0;--I){J.removeChild(J.firstChild)}}function y(I){for(var J=1;J<arguments.length;J+=2){I.setAttribute(arguments[J],arguments[J+1])}}function x(J,I){if(!I){I={}}for(var K in J){if(J.hasOwnProperty(K)){I[K]=J[K]}}return I}function u(O,M,N,J){var L=N?t(O.line,O.ch):O,I=0;for(;;){var K=M.indexOf("\n",I);if(K==-1){break}++L.line;if(J){++J.line}I=K+1}L.ch=(I?0:L.ch)+(M.length-I);if(J){J.ch=(I?0:J.ch)+(M.length-I)}return L}function k(J,I){return(J.line-I.line||J.ch-I.ch)<0?J:I}function m(J,I){return(J.line-I.line||J.ch-I.ch)>0?J:I}function j(J,I){return J.line==I.line&&J.ch==I.ch}});