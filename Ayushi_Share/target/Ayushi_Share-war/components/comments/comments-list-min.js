(function(){var a=YAHOO.util.Dom,u=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML,d=Alfresco.util.userProfileLink,c=Alfresco.Share.userAvatar;Alfresco.CommentsList=function r(z){Alfresco.CommentsList.superclass.constructor.call(this,"Alfresco.CommentsList",z,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("editorInitialized",this.onEditorInitialized,this);YAHOO.Bubbling.on("commentNode",this.onCommentNode,this);YAHOO.Bubbling.on("versionReverted",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);YAHOO.Bubbling.on("metadataRefresh",function(){this.widgets.alfrescoDataTable.reloadDataTable()},this);this.busy=false;this.hashChecked=false;return this};YAHOO.extend(Alfresco.CommentsList,Alfresco.component.Base,{options:{nodeRef:null,siteId:null,activity:null,editorConfig:{}},busy:null,hashChecked:null,onReady:function o(){var z=document.createElement("div");a.addClass(z,"comments-list");a.addClass(z,"hidden");a.get(this.id+"-body").appendChild(z);this.widgets.editFormWrapper=z;YAHOO.util.Event.addListener(window,"resize",function(){if(this.currentEditedRowId){this.synchronizeElements(this.widgets.editFormWrapper,this.currentEditedRowId+"-form-container")}this.resizeCommentDetails()},this,true);this.setupCommentList();this.setupAddCommentForm()},resizeCommentDetails:function i(){var C=a.get(this.id+"-body").offsetWidth,D=YAHOO.util.Selector.query("div.comment-details",this.id+"-body");if(D.length!=0){var A=window.getComputedStyle(D[0],null).getPropertyValue("padding-left").replace("px",""),z=window.getComputedStyle(D[0],null).getPropertyValue("padding-right").replace("px","");C=C-A-z}for(var B=0;B<D.length;B++){D[B].style.width=C+"px"}},setupCommentList:function y(){var z=Alfresco.constants.URL_SERVICECONTEXT+"components/node/"+this.options.nodeRef.replace(":/","")+"/comments?reverse=true";this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:z,pagingResolver:function(A,B){return"startIndex="+A+"&pageSize="+B},config:{responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",paginationRowsPerPage:"pageSize",totalRecords:"total"}}},doBeforeParseData:this.bind(this.handlePermissions)},dataTable:{container:this.id+"-comments-list",columnDefinitions:[{key:"comment",sortable:false,formatter:this.bind(this.renderCellComment)}],config:{MSG_EMPTY:this.msg("message.noComments")}},paginator:{history:false,config:{containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.maxItems}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("beforeRenderEvent",function(){a.removeClass(u.query("hr.hidden"),"hidden")},this,this);this.widgets.alfrescoDataTable.getDataTable().subscribe("renderEvent",function(){this.resizeCommentDetails()},this,this)},handlePermissions:function e(B,z){var A=z.nodePermissions||{};if(A.create){a.removeClass(this.id+"-actions","hidden")}else{a.addClass(this.id+"-actions","hidden")}return z},setupAddCommentForm:function m(){a.get(this.id+"-add-form-container").innerHTML=this.formMarkup(this.id+"-add",Alfresco.constants.USERNAME,null);this.widgets.addCommentEditor=this.setupCommentForm(this.id+"-add",this.options.nodeRef,false).editor},setupCommentForm:function g(D,H,z){var I=D+"-form",G=a.get(D+"-form-container"),B;if(z){B="api/comment/node/"+H.replace(":/","")}else{B="api/node/"+H.replace(":/","")+"/comments"}a.get(I).setAttribute("action",Alfresco.constants.PROXY_URI+B);var E=new YAHOO.widget.Button(D+"-submit",{type:"submit"});E.set("label",this.msg(z?"button.save":"button.addComment"));var C=new YAHOO.widget.Button(D+"-cancel");C.subscribe("click",function(){if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}this.restoreEditForm()},this,true);C.set("label",this.msg("button.cancel"));var F=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,D+"-content",this.options.editorConfig);F.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));F.render();var K=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";F.subscribe(K,function(L){if(F.getContent().length<20||!this.widgets.commentForm.isValid()){F.save();this.widgets.commentForm.validate()}},this,true);if(this.widgets.commentForm!=null){this.widgets.commentForm.hideErrorContainer()}var A=new Alfresco.forms.Form(I);this.widgets.commentForm=A;A.addValidation(D+"-content",this.contentValidation,F);A.setSubmitElements(E);A.setAjaxSubmitMethod(z?Alfresco.util.Ajax.PUT:Alfresco.util.Ajax.POST);A.setAJAXSubmit(true,{successCallback:{fn:function J(L,M){this.restoreEditForm();a.addClass(G,"hidden");this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable();C.set("disabled",false)},scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:function J(L,M){this._releaseBusy();C.set("disabled",false)},scope:this}});A.setSubmitAsJSON(true);A.doBeforeFormSubmit={fn:function(L){this._setBusy(this.msg("message.wait"));C.set("disabled",true);F.save();F.getEditor().undoManager.clear();F.getEditor().nodeChanged()},scope:this};A.doBeforeAjaxRequest={fn:function(L,M){if(this.options.activity){L.dataObj.itemTitle=this.options.activity.itemTitle;L.dataObj.page=this.options.activity.page;L.dataObj.pageParams=YAHOO.lang.JSON.stringify(this.options.activity.pageParams)}return true},scope:this};A.init();return{form:A,editor:F}},contentValidation:function f(C,z,B,A){z.save();return Alfresco.forms.validation.mandatory(C,null,B,A)},restoreEditForm:function n(){if(this.currentEditedRowId){var C=a.get(this.currentEditedRowId+"-form-container"),z=a.get(this.currentEditedRowId+"-comment-container");if(C&&z){a.removeClass(C.parentNode,"theme-bg-color-4");a.addClass(C,"hidden");a.removeClass(z,"hidden");a.addClass(this.widgets.editFormWrapper,"hidden")}}a.addClass(this.id+"-add-form-container","hidden");a.removeClass(this.widgets.onAddCommentClick.get("element"),"hidden");if(this.widgets.alfrescoDataTable.lastResultCount>this.options.maxItems){var B=this.widgets.alfrescoDataTable.widgets.paginator._containers,A=0;for(A=0;A<B.length;++A){a.removeClass(B[A],"hidden")}}},renderCellComment:function b(D,B,F,G){var C=B.getData(),z="",E=this.id+"-"+B.getId(),A=C.permissions;z+='<div id="'+E+'-comment-container" class="comment-details">';z+='   <div class="icon">'+c(C.author.username)+"</div>";z+='   <div class="details">';z+='      <span class="info">';z+=d(C.author.username,C.author.firstName+" "+C.author.lastName,'class="theme-color-1"')+" ";z+=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(C.modifiedOnISO))+"<br/>";z+="      </span>";z+='      <span class="comment-actions">';if(A.edit){z+='       <a href="#" name=".onEditCommentClick" rel="'+B.getId()+'" title="'+this.msg("link.editComment")+'" class="'+this.id+' edit-comment">&nbsp;</a>'}if(A["delete"]){z+='       <a href="#" name=".onConfirmDeleteCommentClick" rel="'+B.getId()+'" title="'+this.msg("link.deleteComment")+'" class="'+this.id+' delete-comment">&nbsp;</a>'}z+="      </span>";z+='      <div class="comment-content">'+(C.content||"")+"</div>";z+="   </div>";z+='   <div class="clear"></div>';z+="</div>";z+='<div id="'+E+'-form-container" class="comment-form hidden">';z+="   &nbsp;<!-- EMPTY SPACE FOR FLOATING COMMENT FORM -->";z+="</div>";D.innerHTML=z},formMarkup:function p(B,A,C){var z="";z+='<div id="'+B+'-actual-form-container" class="comment-form">';z+='   <h2 class="thin dark">'+this.msg(C?"header.edit":"header.add")+"</h2>";z+=c(A);z+='   <form id="'+B+'-form" method="POST" action="">';if(this.options.siteId){z+='      <input type="hidden" name="site" value="'+this.options.siteId+'" />'}z+='      <textarea name="content" id="'+B+'-content" style="width: 100%">'+(C||"")+"</textarea>";z+='      <div class="buttons">';z+='         <input type="submit" id="'+B+'-submit" value=""/>';z+='         <input type="reset"  id="'+B+'-cancel" value="" />';z+="      </div>";z+="   </form>";z+='   <div class="clear"></div>';z+="</div>";return z},onEditorInitialized:function k(){if(!this.hashChecked&&window.location.hash=="#comment"){this.hashChecked=true;this.onAddCommentClick(true);a.get(this.id+"-add-comment").scrollIntoView()}},onCommentNode:function w(A,z){if(this.options.nodeRef==z[1]){this.onAddCommentClick();a.get(this.id+"-add-comment").scrollIntoView()}},onAddCommentClick:function q(A){this.restoreEditForm();if(A==null){this.setupAddCommentForm()}a.addClass(this.widgets.onAddCommentClick.get("element"),"hidden");this.widgets.addCommentEditor.setContent("");this.widgets.addCommentEditor.save();a.removeClass(this.id+"-add-form-container","hidden");this.widgets.addCommentEditor.focus();if(document.activeElement.nodeName!="IFRAME"){var z=this.widgets.addCommentEditor;window.setTimeout(function(){z.focus()},500)}},onEditCommentClick:function t(B){this.restoreEditForm();var F=this.widgets.alfrescoDataTable.getData(B),D=this.id+"-"+B,C=a.get(D+"-form-container"),E=a.get(D+"-comment-container");this.currentEditedRowId=D;a.addClass(C.parentNode,"theme-bg-color-4");a.addClass(E,"hidden");a.removeClass(C,"hidden");this.widgets.editFormWrapper.innerHTML=this.formMarkup(D,F.author.username,F.content);this.widgets.editCommentEditor=this.setupCommentForm(D,F.nodeRef,true).editor;this.synchronizeElements(this.widgets.editFormWrapper,C);a.removeClass(this.widgets.editFormWrapper,"hidden");var A=this.widgets.alfrescoDataTable.widgets.paginator._containers,z=0;for(z=0;z<A.length;++z){a.addClass(A[z],"hidden")}this.widgets.editCommentEditor.focus()},synchronizeElements:function x(C,z){var B=new YAHOO.util.Element(z),A=new YAHOO.util.Element(C),D=YAHOO.util.Dom.getRegion(B.get("id"));A.setStyle("position","absolute");A.setStyle("left",D.left+"px");A.setStyle("top",D.top+"px");A.setStyle("width",D.width+"px");A.setStyle("height",D.height+"px")},onConfirmDeleteCommentClick:function v(B){var D=this.widgets.alfrescoDataTable.getData(B),C=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function A(){this.destroy();C.deleteComment.call(C,D)}},{text:this.msg("button.cancel"),handler:function z(){this.destroy()},isDefault:true}]})},deleteComment:function l(F){if(!this._setBusy(this.msg("message.wait"))){return}var E=function C(G,I){this._releaseBusy();if(this.widgets.alfrescoDataTable.lastResultCount==1&&this.widgets.alfrescoDataTable.currentSkipCount>0){var H=this.widgets.alfrescoDataTable;H.currentSkipCount=H.currentSkipCount-H.currentMaxItems}this.widgets.alfrescoDataTable.reloadDataTable()};var B=function z(G,H){this._releaseBusy()};var A=Alfresco.constants.PROXY_URI+"api/comment/node/"+F.nodeRef.replace(":/",""),D=false;if(this.options.siteId){A+=D?"&":"?";A+="site="+encodeURIComponent(this.options.siteId);D=true}if(this.options.activity){A+=D?"&":"?";A+="itemTitle="+encodeURIComponent(this.options.activity.itemTitle)+"&";A+="page="+encodeURIComponent(this.options.activity.page)+"&";A+="pageParams="+encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activity.pageParams));D=true}Alfresco.util.Ajax.jsonDelete({url:A,successMessage:this.msg("message.delete.success"),successCallback:{fn:E,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:B,scope:this}})},_setBusy:function h(z){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:z,spanClass:"wait",displayTime:0});return true},_releaseBusy:function j(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();