(function(){var h=YAHOO.util.Dom;var e=Alfresco.util.encodeHTML,f=Alfresco.util.combinePaths,g=Alfresco.util.siteURL;Alfresco.DocumentActions=function(l){Alfresco.DocumentActions.superclass.constructor.call(this,"Alfresco.DocumentActions",l,["button"]);this.actionsView="details";YAHOO.Bubbling.on("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.on("metadataRefresh",this.doRefresh,this);YAHOO.Bubbling.on("registerAction",this.onRegisterAction,this);return this};YAHOO.extend(Alfresco.DocumentActions,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.DocumentActions,Alfresco.doclib.Actions);YAHOO.lang.augmentObject(Alfresco.DocumentActions.prototype,{options:{nodeRef:null,siteId:null,containerId:"documentLibrary",inlineEditMimetypes:{"text/plain":true,"text/html":true,"text/xml":true},rootNode:"alfresco://company/home",replicationUrlMapping:{},documentDetails:null,repositoryBrowsing:true},recordData:null,doclistMetadata:null,currentPath:null,onReady:function c(){var y=this;this.recordData=this.options.documentDetails.item;this.doclistMetadata=this.options.documentDetails.metadata;this.currentPath=this.recordData.location.path;this.recordData.jsNode=new Alfresco.util.Node(this.recordData.node);var u=this.recordData,n=u.node,o=u.actions,p=h.get(this.id+"-actionSet"),x="",t;u.actionParams={};for(var s=0,B=o.length;s<B;s++){x+=this.renderAction(o[s],u)}var m=this.getActionUrls(u);p.innerHTML=YAHOO.lang.substitute(x,m);h.addClass(p,"action-set");h.setStyle(p,"visibility","visible");var z=u.displayName,r=m.downloadUrl;var A=function v(E,D){var C=YAHOO.Bubbling.getOwnerByTagName(D[1].anchor,"div");if(C!==null){if(typeof y[C.id]==="function"){D[1].stop=true;try{y[C.id].call(y,y.recordData,C)}catch(F){Alfresco.logger.error("DocumentActions_fnActionHandler",C.id,F)}}}return true};YAHOO.Bubbling.addDefaultAction("action-link",A);this.modules.actions=new Alfresco.module.DoclibActions();if(window.location.hash=="#editOffline"){window.location.hash="";var l=false;YAHOO.Bubbling.on("editingCanceled",function(D,C){if(u.workingCopy.sourceNodeRef==C[1].record.workingCopy.sourceNodeRef){l=true}},this);if(YAHOO.env.ua.ie>6){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.edit-offline.success",z),text:this.msg("message.edit-offline.success.ie7"),buttons:[{text:this.msg("button.download"),handler:function q(){window.location=r;this.destroy()},isDefault:true},{text:this.msg("button.close"),handler:function w(){this.destroy()}}]})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-offline.success",z)});YAHOO.lang.later(3000,this,function(){if(!l){window.location=r}})}}if(window.location.hash=="#editCancelled"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-cancel.success",z)})}if(window.location.hash=="#newVersionUpload"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-version-upload.success")})}},onActionEditOffline:function b(n){var l=n.displayName,m=new Alfresco.util.NodeRef(n.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function o(p){this.recordData.jsNode.setNodeRef(p.json.results[0].nodeRef);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editOffline"},scope:this}},failure:{message:this.msg("message.edit-offline.failure",l)},webscript:{method:Alfresco.util.Ajax.POST,name:"checkout/node/{nodeRef}",params:{nodeRef:m.uri}}})},onActionCancelEditing:function i(o){var l=o.displayName,n=new Alfresco.util.NodeRef(o.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function m(r){var q=this.recordData.jsNode.nodeRef.nodeRef,p=r.json.results[0].nodeRef;this.recordData.jsNode.setNodeRef(p);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editCancelled";if(q==p){window.location.reload()}},scope:this}},failure:{message:this.msg("message.edit-cancel.failure",l)},webscript:{method:Alfresco.util.Ajax.POST,name:"cancel-checkout/node/{nodeRef}",params:{nodeRef:n.uri}}});YAHOO.Bubbling.fire("editingCanceled",{record:o})},onActionUploadNewVersion:function j(p){var m=p.displayName,o=new Alfresco.util.NodeRef(p.nodeRef),l=p.version;if(!this.fileUpload){this.fileUpload=Alfresco.getFileUploadInstance()}var r=this.msg("label.filter-description",m),n="*";if(m&&new RegExp(/[^\.]+\.[^\.]+/).exec(m)){n="*"+m.substring(m.lastIndexOf("."))}if(p.workingCopy&&p.workingCopy.workingCopyVersion){l=p.workingCopy.workingCopyVersion}var q={updateNodeRef:o.toString(),updateFilename:m,updateVersion:l,suppressRefreshEvent:true,overwrite:true,filter:[{description:r,extensions:n}],mode:this.fileUpload.MODE_SINGLE_UPDATE,onFileUploadComplete:{fn:this.onNewVersionUploadCompleteCustom,scope:this}};if(Alfresco.util.isValueSet(this.options.siteId)){q.siteId=this.options.siteId;q.containerId=this.options.containerId}this.fileUpload.show(q)},onNewVersionUploadCompleteCustom:function a(l){this.recordData.jsNode.setNodeRef(l.successful[0].nodeRef);var o=this.getActionUrls(this.recordData).documentDetailsUrl+"#newVersionUpload";var n=this.recordData.jsNode.nodeRef.nodeRef,m=this.recordData.nodeRef;Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.documentlibrary.file-updated",l.successful[0].fileName,"document-details?nodeRef="+l.successful[0].nodeRef,{fileName:l.successful[0].fileName,nodeRef:l.successful[0].nodeRef},function(){window.location=o;if(n==m){window.location.reload()}})},_onActionDeleteConfirm:function k(n){var t=n.location.path;if(Alfresco.constants.PAGECONTEXT=="mine"||Alfresco.constants.PAGECONTEXT=="shared"){var u=t.substring(1);if(Alfresco.constants.PAGECONTEXT=="mine"){u=u.substring(u.indexOf("/")+1)}var l=u.indexOf("/");if(l!=-1){t=u.substring(l)}else{t=""}}var m=n.fileName,r=n.displayName,s=new Alfresco.util.NodeRef(n.nodeRef),q="",o=t.length>1?"?path="+encodeURIComponent(t):"";if(Alfresco.constants.PAGECONTEXT=="mine"){q="myfiles"}else{if(Alfresco.constants.PAGECONTEXT=="shared"){q="sharedfiles"}else{q=Alfresco.util.isValueSet(this.options.siteId)?"documentlibrary":"repository"}}this.modules.actions.genericAction({success:{activity:{siteId:this.options.siteId,activityType:"file-deleted",page:"documentlibrary",activityData:{fileName:m,path:t,nodeRef:s.toString()}},callback:{fn:function p(v){window.location=g(q+o)}}},failure:{message:this.msg("message.delete.failure",r)},webscript:{method:Alfresco.util.Ajax.DELETE,name:"file/node/{nodeRef}",params:{nodeRef:s.uri}}})},doRefresh:function d(){YAHOO.Bubbling.unsubscribe("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);this.refresh("components/document-details/document-actions?nodeRef={nodeRef}"+(this.options.siteId?"&site={siteId}":""))}},true)})();